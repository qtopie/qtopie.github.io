<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>Java程序是怎么运行的? | 1001問</title><link rel=stylesheet href=/css/main.min.194caa9c1bc917dfa8a85f5f1f9061c52cd72509dc9f189142b69308127558b3.css integrity="sha256-GUyqnBvJF9+oqF9fH5BhxSzXJQncnxiRQraTCBJ1WLM=" crossorigin=anonymous><link rel=stylesheet href=/css/page.min.90a490d604fcd054d4b5219c88265352a75714a866b26e428b192affa9f31af5.css integrity="sha256-kKSQ1gT80FTUtSGciCZTUqdXFKhmsm5Cixkq/6nzGvU=" crossorigin=anonymous><link rel=stylesheet href=/css/syntax.min.e114b8cc38f57d520f373580c935a518bc6afd6dec4f1d682365cdbcf5c8218a.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css crossorigin=anonymous referrerpolicy=no-referrer><script src=/js/toc.min.87636f25caf644980403a5c1ce8b0812cfd10d1e53c08f181547966799ceccdb.js integrity="sha256-h2NvJcr2RJgEA6XBzosIEs/RDR5TwI8YFUeWZ5nOzNs=" crossorigin=anonymous type=module defer></script><script src=/js/copy-code.min.3bea0de4cfe8670f94a5d75c177f07b58fc90178efdea7f2a21449798d75b2c9.js integrity="sha256-O+oN5M/oZw+UpddcF38HtY/JAXjv3qfyohRJeY11ssk=" crossorigin=anonymous defer></script><script defer src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script defer src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js crossorigin=anonymous referrerpolicy=no-referrer onload='renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],throwOnError:!1})'></script><script src=/js/katex-block.min.2cf531bbcc318aadf5661baa2d0987ab5cb4daef473e108b1da714a37cff0b25.js integrity="sha256-LPUxu8wxiq31ZhuqLQmHq1y02u9HPhCLHacUo3z/CyU=" crossorigin=anonymous defer></script></head><body><header><nav><a href=/><h1>1001問</h1></a><div id=react-search class=search-root aria-label="Site Search"></div></nav></header><main><div class=sidebar><section class=toc><nav id=TableOfContents><ul><li><a href=#总览>总览</a></li><li><a href=#主流程>主流程</a><ul><li><a href=#源码编译javac>源码编译（javac）</a></li><li><a href=#类加载class-loading>类加载（Class Loading）</a></li><li><a href=#解释执行与jit编译>解释执行与JIT编译</a></li><li><a href=#运行期优化jit优化>运行期优化（JIT优化）</a></li><li><a href=#执行时内存与gc>执行时内存与GC</a></li></ul></li><li><a href=#关键细节>关键细节</a><ul><li><a href=#类加载触发条件主动使用>类加载触发条件（主动使用）</a></li><li><a href=#字节码验证与链接细节>字节码验证与链接细节</a></li></ul></li><li><a href=#执行与优化>执行与优化</a><ul><li><a href=#c1c2与分层编译>C1/C2与分层编译</a></li><li><a href=#常见jit优化案例>常见JIT优化案例</a></li><li><a href=#反优化deoptimization>反优化（Deoptimization）</a></li></ul></li><li><a href=#cpu与调度视角>CPU与调度视角</a><ul><li><a href=#从cpu视角理解执行流程>从CPU视角理解执行流程</a></li><li><a href=#jvm层面的cpu调度视角>JVM层面的CPU调度视角</a></li></ul></li><li><a href=#运行期监控与排查建议>运行期监控与排查建议</a></li><li><a href=#相关知识>相关知识</a><ul><li><a href=#被动引用不会初始化与懒加载实现>被动引用不会初始化与懒加载实现</a></li><li><a href=#双亲委派parents-delegate>双亲委派(parents delegate)</a></li></ul></li></ul></nav></section></div><article id=content><div class=metadata><h1>Java程序是怎么运行的?</h1><time datetime=2026-02-08T00:00:00+00:00>February 8, 2026</time><div class=taxonomy></div></div><h2 id=总览>总览</h2><p>从Java源码到JVM执行，大致分为“编译 -> 类加载 -> 字节码验证与链接 -> 解释/编译执行 -> 运行期优化”几个阶段。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>.java -&gt; javac -&gt; .class -&gt; 类加载/验证/链接/初始化 -&gt; 解释执行 + JIT -&gt; 运行期优化 + GC
</span></span></code></pre></div><div class=mermaid-block data-mermaid-zoom=1><div class=mermaid-toolbar><button class=mermaid-btn type=button data-action=zoom-in aria-label="Zoom in">+</button>
<button class=mermaid-btn type=button data-action=zoom-out aria-label="Zoom out">-</button>
<button class=mermaid-btn type=button data-action=reset aria-label="Reset zoom">100%</button>
<button class=mermaid-btn type=button data-action=fullscreen aria-label="Toggle fullscreen">Full</button></div><div class="mermaid mermaid-canvas">flowchart LR
A[Java Source .java] --> B[javac Compile]
B --> C[Bytecode .class]
subgraph L[Class Loading]
D[Loading]
E[Verification]
F[Preparation]
G[Resolution]
H[Initialization]
D --> E --> F --> G --> H
end
subgraph R[Runtime Execution]
I[Interpreter Execute]
J{Hot Method?}
K[JIT Compile]
L2[Machine Code]
M[Runtime Optimization]
N[GC + Deoptimization]
I --> J
J -- No --> I
J -- Yes --> K --> L2 --> M --> N
end
C --> D
H --> I</div></div><h2 id=主流程>主流程</h2><h3 id=源码编译javac>源码编译（javac）</h3><ul><li>输入：<code>.java</code>源码文件</li><li>输出：<code>.class</code>字节码文件</li><li>编译内容：语法/类型检查、常量折叠、语法糖解 desugar、生成字节码与调试信息（如行号表）</li></ul><blockquote><p>这一步只是把源码转换为平台无关的字节码，不生成机器码。</p></blockquote><h4 id=一个小示例>一个小示例</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Hello</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>NAME</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;qtopie&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>cnt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>count</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>++</span><span class=n>cnt</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Hello, World!&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>NAME</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>count</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>cnt</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>反编译为汇编查看字节码<code>javap -v Hello</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Classfile</span><span class=w> </span><span class=o>/</span><span class=n>home</span><span class=o>/</span><span class=n>qtopierw</span><span class=o>/</span><span class=n>workspace</span><span class=o>/</span><span class=n>projects</span><span class=o>/</span><span class=n>qtopie</span><span class=p>.</span><span class=na>github</span><span class=p>.</span><span class=na>io</span><span class=o>/</span><span class=n>posts</span><span class=o>/</span><span class=n>Hello</span><span class=p>.</span><span class=na>class</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>Last</span><span class=w> </span><span class=n>modified</span><span class=w> </span><span class=n>Feb</span><span class=w> </span><span class=n>10</span><span class=p>,</span><span class=w> </span><span class=n>2026</span><span class=p>;</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=n>689</span><span class=w> </span><span class=n>bytes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>SHA</span><span class=o>-</span><span class=n>256</span><span class=w> </span><span class=n>checksum</span><span class=w> </span><span class=n>af50a475fe0a0608d09466e01af47f0658b67fb73543869e55d4a7756913eb1a</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>Compiled</span><span class=w> </span><span class=n>from</span><span class=w> </span><span class=s>&#34;Hello.java&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Hello</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>minor</span><span class=w> </span><span class=n>version</span><span class=p>:</span><span class=w> </span><span class=n>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>major</span><span class=w> </span><span class=n>version</span><span class=p>:</span><span class=w> </span><span class=n>65</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>flags</span><span class=p>:</span><span class=w> </span><span class=p>(</span><span class=n>0x0021</span><span class=p>)</span><span class=w> </span><span class=n>ACC_PUBLIC</span><span class=p>,</span><span class=w> </span><span class=n>ACC_SUPER</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>this_class</span><span class=p>:</span><span class=w> </span><span class=err>#</span><span class=n>8</span><span class=w>                          </span><span class=c1>// Hello</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>super_class</span><span class=p>:</span><span class=w> </span><span class=err>#</span><span class=n>2</span><span class=w>                         </span><span class=c1>// java/lang/Object</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>interfaces</span><span class=p>:</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>fields</span><span class=p>:</span><span class=w> </span><span class=n>2</span><span class=p>,</span><span class=w> </span><span class=n>methods</span><span class=p>:</span><span class=w> </span><span class=n>4</span><span class=p>,</span><span class=w> </span><span class=n>attributes</span><span class=p>:</span><span class=w> </span><span class=n>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>Constant</span><span class=w> </span><span class=n>pool</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=err>#</span><span class=n>1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Methodref</span><span class=w>          </span><span class=err>#</span><span class=n>2</span><span class=p>.</span><span class=err>#</span><span class=n>3</span><span class=w>          </span><span class=c1>// java/lang/Object.&#34;&lt;init&gt;&#34;:()V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=err>#</span><span class=n>2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=w>              </span><span class=err>#</span><span class=n>4</span><span class=w>             </span><span class=c1>// java/lang/Object</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=err>#</span><span class=n>3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>NameAndType</span><span class=w>        </span><span class=err>#</span><span class=n>5</span><span class=p>:</span><span class=err>#</span><span class=n>6</span><span class=w>          </span><span class=c1>// &#34;&lt;init&gt;&#34;:()V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=err>#</span><span class=n>4</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Utf8</span><span class=w>               </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Object</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=err>#</span><span class=n>5</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Utf8</span><span class=w>               </span><span class=o>&lt;</span><span class=n>init</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=err>#</span><span class=n>6</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Utf8</span><span class=w>               </span><span class=p>()</span><span class=n>V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=err>#</span><span class=n>7</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Fieldref</span><span class=w>           </span><span class=err>#</span><span class=n>8</span><span class=p>.</span><span class=err>#</span><span class=n>9</span><span class=w>          </span><span class=c1>// Hello.cnt:I</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=err>#</span><span class=n>8</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=w>              </span><span class=err>#</span><span class=n>10</span><span class=w>            </span><span class=c1>// Hello</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=err>#</span><span class=n>9</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>NameAndType</span><span class=w>        </span><span class=err>#</span><span class=n>11</span><span class=p>:</span><span class=err>#</span><span class=n>12</span><span class=w>        </span><span class=c1>// cnt:I</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>10</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Utf8</span><span class=w>               </span><span class=n>Hello</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>11</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Utf8</span><span class=w>               </span><span class=n>cnt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>12</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Utf8</span><span class=w>               </span><span class=n>I</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>13</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Fieldref</span><span class=w>           </span><span class=err>#</span><span class=n>14</span><span class=p>.</span><span class=err>#</span><span class=n>15</span><span class=w>        </span><span class=c1>// java/lang/System.out:Ljava/io/PrintStream;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>14</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=w>              </span><span class=err>#</span><span class=n>16</span><span class=w>            </span><span class=c1>// java/lang/System</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>15</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>NameAndType</span><span class=w>        </span><span class=err>#</span><span class=n>17</span><span class=p>:</span><span class=err>#</span><span class=n>18</span><span class=w>        </span><span class=c1>// out:Ljava/io/PrintStream;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>16</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Utf8</span><span class=w>               </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>System</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>17</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Utf8</span><span class=w>               </span><span class=n>out</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>18</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Utf8</span><span class=w>               </span><span class=n>Ljava</span><span class=o>/</span><span class=n>io</span><span class=o>/</span><span class=n>PrintStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>19</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>String</span><span class=w>             </span><span class=err>#</span><span class=n>20</span><span class=w>            </span><span class=c1>// Hello, World!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>20</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Utf8</span><span class=w>               </span><span class=n>Hello</span><span class=p>,</span><span class=w> </span><span class=n>World</span><span class=o>!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>21</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Methodref</span><span class=w>          </span><span class=err>#</span><span class=n>22</span><span class=p>.</span><span class=err>#</span><span class=n>23</span><span class=w>        </span><span class=c1>// java/io/PrintStream.println:(Ljava/lang/String;)V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>22</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=w>              </span><span class=err>#</span><span class=n>24</span><span class=w>            </span><span class=c1>// java/io/PrintStream</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>23</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>NameAndType</span><span class=w>        </span><span class=err>#</span><span class=n>25</span><span class=p>:</span><span class=err>#</span><span class=n>26</span><span class=w>        </span><span class=c1>// println:(Ljava/lang/String;)V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>24</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Utf8</span><span class=w>               </span><span class=n>java</span><span class=o>/</span><span class=n>io</span><span class=o>/</span><span class=n>PrintStream</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>25</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Utf8</span><span class=w>               </span><span class=n>println</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>26</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Utf8</span><span class=w>               </span><span class=p>(</span><span class=n>Ljava</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>String</span><span class=p>;)</span><span class=n>V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>27</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>String</span><span class=w>             </span><span class=err>#</span><span class=n>28</span><span class=w>            </span><span class=c1>// qtopie</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>28</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Utf8</span><span class=w>               </span><span class=n>qtopie</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>29</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Methodref</span><span class=w>          </span><span class=err>#</span><span class=n>8</span><span class=p>.</span><span class=err>#</span><span class=n>30</span><span class=w>         </span><span class=c1>// Hello.count:()V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>30</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>NameAndType</span><span class=w>        </span><span class=err>#</span><span class=n>31</span><span class=p>:</span><span class=err>#</span><span class=n>6</span><span class=w>         </span><span class=c1>// count:()V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>31</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Utf8</span><span class=w>               </span><span class=n>count</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>32</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Methodref</span><span class=w>          </span><span class=err>#</span><span class=n>22</span><span class=p>.</span><span class=err>#</span><span class=n>33</span><span class=w>        </span><span class=c1>// java/io/PrintStream.println:(I)V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>33</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>NameAndType</span><span class=w>        </span><span class=err>#</span><span class=n>25</span><span class=p>:</span><span class=err>#</span><span class=n>34</span><span class=w>        </span><span class=c1>// println:(I)V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>34</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Utf8</span><span class=w>               </span><span class=p>(</span><span class=n>I</span><span class=p>)</span><span class=n>V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>35</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Utf8</span><span class=w>               </span><span class=n>NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>36</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Utf8</span><span class=w>               </span><span class=n>Ljava</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>String</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>37</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Utf8</span><span class=w>               </span><span class=n>ConstantValue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>38</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Utf8</span><span class=w>               </span><span class=n>Code</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>39</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Utf8</span><span class=w>               </span><span class=n>LineNumberTable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>40</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Utf8</span><span class=w>               </span><span class=n>main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>41</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Utf8</span><span class=w>               </span><span class=p>(</span><span class=o>[</span><span class=n>Ljava</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>String</span><span class=p>;)</span><span class=n>V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>42</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Utf8</span><span class=w>               </span><span class=o>&lt;</span><span class=n>clinit</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>43</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Utf8</span><span class=w>               </span><span class=n>SourceFile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>#</span><span class=n>44</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Utf8</span><span class=w>               </span><span class=n>Hello</span><span class=p>.</span><span class=na>java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=nf>Hello</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>descriptor</span><span class=p>:</span><span class=w> </span><span class=p>()</span><span class=n>V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>flags</span><span class=p>:</span><span class=w> </span><span class=p>(</span><span class=n>0x0001</span><span class=p>)</span><span class=w> </span><span class=n>ACC_PUBLIC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Code</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>stack</span><span class=o>=</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>locals</span><span class=o>=</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>args_size</span><span class=o>=</span><span class=n>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>0</span><span class=p>:</span><span class=w> </span><span class=n>aload_0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>1</span><span class=p>:</span><span class=w> </span><span class=n>invokespecial</span><span class=w> </span><span class=err>#</span><span class=n>1</span><span class=w>                  </span><span class=c1>// Method java/lang/Object.&#34;&lt;init&gt;&#34;:()V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>4</span><span class=p>:</span><span class=w> </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>LineNumberTable</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>line</span><span class=w> </span><span class=n>2</span><span class=p>:</span><span class=w> </span><span class=n>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>count</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>descriptor</span><span class=p>:</span><span class=w> </span><span class=p>()</span><span class=n>V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>flags</span><span class=p>:</span><span class=w> </span><span class=p>(</span><span class=n>0x0029</span><span class=p>)</span><span class=w> </span><span class=n>ACC_PUBLIC</span><span class=p>,</span><span class=w> </span><span class=n>ACC_STATIC</span><span class=p>,</span><span class=w> </span><span class=n>ACC_SYNCHRONIZED</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Code</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>stack</span><span class=o>=</span><span class=n>2</span><span class=p>,</span><span class=w> </span><span class=n>locals</span><span class=o>=</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>args_size</span><span class=o>=</span><span class=n>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>0</span><span class=p>:</span><span class=w> </span><span class=n>getstatic</span><span class=w>     </span><span class=err>#</span><span class=n>7</span><span class=w>                  </span><span class=c1>// Field cnt:I</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>3</span><span class=p>:</span><span class=w> </span><span class=n>iconst_1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>4</span><span class=p>:</span><span class=w> </span><span class=n>iadd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>5</span><span class=p>:</span><span class=w> </span><span class=n>putstatic</span><span class=w>     </span><span class=err>#</span><span class=n>7</span><span class=w>                  </span><span class=c1>// Field cnt:I</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>8</span><span class=p>:</span><span class=w> </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>LineNumberTable</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>line</span><span class=w> </span><span class=n>8</span><span class=p>:</span><span class=w> </span><span class=n>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>line</span><span class=w> </span><span class=n>9</span><span class=p>:</span><span class=w> </span><span class=n>8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>String</span><span class=o>[]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>descriptor</span><span class=p>:</span><span class=w> </span><span class=p>(</span><span class=o>[</span><span class=n>Ljava</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>String</span><span class=p>;)</span><span class=n>V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>flags</span><span class=p>:</span><span class=w> </span><span class=p>(</span><span class=n>0x0009</span><span class=p>)</span><span class=w> </span><span class=n>ACC_PUBLIC</span><span class=p>,</span><span class=w> </span><span class=n>ACC_STATIC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Code</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>stack</span><span class=o>=</span><span class=n>2</span><span class=p>,</span><span class=w> </span><span class=n>locals</span><span class=o>=</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>args_size</span><span class=o>=</span><span class=n>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>0</span><span class=p>:</span><span class=w> </span><span class=n>getstatic</span><span class=w>     </span><span class=err>#</span><span class=n>13</span><span class=w>                 </span><span class=c1>// Field java/lang/System.out:Ljava/io/PrintStream;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>3</span><span class=p>:</span><span class=w> </span><span class=n>ldc</span><span class=w>           </span><span class=err>#</span><span class=n>19</span><span class=w>                 </span><span class=c1>// String Hello, World!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>5</span><span class=p>:</span><span class=w> </span><span class=n>invokevirtual</span><span class=w> </span><span class=err>#</span><span class=n>21</span><span class=w>                 </span><span class=c1>// Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>8</span><span class=p>:</span><span class=w> </span><span class=n>getstatic</span><span class=w>     </span><span class=err>#</span><span class=n>13</span><span class=w>                 </span><span class=c1>// Field java/lang/System.out:Ljava/io/PrintStream;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>11</span><span class=p>:</span><span class=w> </span><span class=n>ldc</span><span class=w>           </span><span class=err>#</span><span class=n>27</span><span class=w>                 </span><span class=c1>// String qtopie</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>13</span><span class=p>:</span><span class=w> </span><span class=n>invokevirtual</span><span class=w> </span><span class=err>#</span><span class=n>21</span><span class=w>                 </span><span class=c1>// Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>16</span><span class=p>:</span><span class=w> </span><span class=n>invokestatic</span><span class=w>  </span><span class=err>#</span><span class=n>29</span><span class=w>                 </span><span class=c1>// Method count:()V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>19</span><span class=p>:</span><span class=w> </span><span class=n>getstatic</span><span class=w>     </span><span class=err>#</span><span class=n>13</span><span class=w>                 </span><span class=c1>// Field java/lang/System.out:Ljava/io/PrintStream;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>22</span><span class=p>:</span><span class=w> </span><span class=n>getstatic</span><span class=w>     </span><span class=err>#</span><span class=n>7</span><span class=w>                  </span><span class=c1>// Field cnt:I</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>25</span><span class=p>:</span><span class=w> </span><span class=n>invokevirtual</span><span class=w> </span><span class=err>#</span><span class=n>32</span><span class=w>                 </span><span class=c1>// Method java/io/PrintStream.println:(I)V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>28</span><span class=p>:</span><span class=w> </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>LineNumberTable</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>line</span><span class=w> </span><span class=n>12</span><span class=p>:</span><span class=w> </span><span class=n>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>line</span><span class=w> </span><span class=n>14</span><span class=p>:</span><span class=w> </span><span class=n>8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>line</span><span class=w> </span><span class=n>16</span><span class=p>:</span><span class=w> </span><span class=n>16</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>line</span><span class=w> </span><span class=n>17</span><span class=p>:</span><span class=w> </span><span class=n>19</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>line</span><span class=w> </span><span class=n>18</span><span class=p>:</span><span class=w> </span><span class=n>28</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>static</span><span class=w> </span><span class=p>{};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>descriptor</span><span class=p>:</span><span class=w> </span><span class=p>()</span><span class=n>V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>flags</span><span class=p>:</span><span class=w> </span><span class=p>(</span><span class=n>0x0008</span><span class=p>)</span><span class=w> </span><span class=n>ACC_STATIC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Code</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>stack</span><span class=o>=</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>locals</span><span class=o>=</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>args_size</span><span class=o>=</span><span class=n>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>0</span><span class=p>:</span><span class=w> </span><span class=n>iconst_0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>1</span><span class=p>:</span><span class=w> </span><span class=n>putstatic</span><span class=w>     </span><span class=err>#</span><span class=n>7</span><span class=w>                  </span><span class=c1>// Field cnt:I</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>4</span><span class=p>:</span><span class=w> </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>LineNumberTable</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>line</span><span class=w> </span><span class=n>4</span><span class=p>:</span><span class=w> </span><span class=n>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nl>SourceFile</span><span class=p>:</span><span class=w> </span><span class=s>&#34;Hello.java&#34;</span><span class=w>
</span></span></span></code></pre></div><h3 id=类加载class-loading>类加载（Class Loading）</h3><p>当类第一次被“主动使用”时，类加载器会把<code>.class</code>读取进JVM，并生成<code>java.lang.Class</code>对象。主要步骤：</p><ul><li>加载（Loading）：从类路径、模块、网络等位置读取字节码</li><li>验证（Verification）：校验字节码格式、类型安全、栈映射等</li><li>准备（Preparation）：为静态变量分配内存并设置默认值</li><li>解析（Resolution）：将符号引用解析为直接引用</li><li>初始化（Initialization）：执行<code>&lt;clinit></code>（静态变量赋值与静态代码块）</li></ul><p>类加载器模型：Bootstrap -> Platform -> Application（自定义类加载器可打破双亲委派）。</p><blockquote><p>解析（Resolution）就是把常量池里的“符号引用”（名字+描述信息）转换成“直接引用”（JVM能直接定位到的运行时结构指针/句柄）。</p><p>符号引用：比如类名、接口名、字段名、方法名、描述符等，和具体内存地址无关。
直接引用：指向已加载类的运行时数据结构，或可直接定位方法入口的引用（例如方法表中的索引或指针）。
解析发生时机可能是链接阶段（类加载时）或首次使用（惰性解析）。解析完成后，后续调用就不必再通过名字查找，性能更高，也确保访问合法性（权限检查、存在性检查等）。</p></blockquote><h3 id=解释执行与jit编译>解释执行与JIT编译</h3><p>JVM最初会通过解释器执行字节码；当方法被频繁调用（热点方法）时，JIT会把字节码编译成本地机器码，提升性能。</p><ul><li>解释器：启动快，执行慢</li><li>JIT（C1/C2）：启动慢，执行快</li><li>分层编译：先用C1快速编译，再用C2做更深度优化</li></ul><h3 id=运行期优化jit优化>运行期优化（JIT优化）</h3><p>JIT会基于运行时数据做优化，例如：</p><ul><li>方法内联</li><li>逃逸分析与标量替换</li><li>去虚拟化（单态调用）</li><li>循环展开、消除范围检查</li></ul><p>这些优化是“有条件”的，如果运行时假设不成立，JVM会触发反优化并回退到解释执行。</p><h3 id=执行时内存与gc>执行时内存与GC</h3><p>程序运行时主要在堆和方法区（元空间）分配对象和类元数据，GC负责回收无用对象。常见阶段：</p><ul><li>新生代（Minor GC）</li><li>老年代（Major/Full GC）</li><li>元空间回收（类卸载）</li></ul><h2 id=关键细节>关键细节</h2><h3 id=类加载触发条件主动使用>类加载触发条件（主动使用）</h3><p>JVM只会在类被“主动使用”时初始化，常见触发场景：</p><ul><li><code>new</code>一个类实例</li><li>访问类的静态字段（非<code>final</code>编译期常量）</li><li>调用类的静态方法</li><li>反射调用</li><li>初始化子类时先初始化父类</li><li>作为程序入口（包含<code>main</code>方法的类）</li></ul><p>被动引用不会触发初始化，如：</p><ul><li>通过数组引用类（<code>SomeClass[]</code>）</li><li>访问<code>static final</code>编译期常量</li><li>仅获取<code>Class</code>对象但不触发初始化（某些反射路径）</li></ul><h3 id=字节码验证与链接细节>字节码验证与链接细节</h3><p>验证主要为了安全和类型一致性，分为四类检查：</p><ul><li>文件格式验证：魔数、版本、常量池结构</li><li>元数据验证：类继承、接口实现、字段方法描述符</li><li>字节码验证：操作数栈/局部变量表类型匹配、控制流合法</li><li>符号引用验证：访问权限、引用目标存在</li></ul><p>链接阶段包括：</p><ul><li>准备：为静态变量分配内存并设置默认值（非显式赋值）</li><li>解析：把常量池符号引用解析为直接引用</li></ul><h2 id=执行与优化>执行与优化</h2><h3 id=c1c2与分层编译>C1/C2与分层编译</h3><ul><li>C1（Client Compiler）：编译速度快，优化较保守</li><li>C2（Server Compiler）：编译慢，优化深入</li><li>分层编译：先C1快速编译，再用C2替换热点机器码</li></ul><p>常用参数（仅示意）：</p><ul><li><code>-XX:+TieredCompilation</code></li><li><code>-XX:TieredStopAtLevel=1</code>（只用C1）</li><li><code>-XX:-TieredCompilation</code>（只用C2）</li></ul><h3 id=常见jit优化案例>常见JIT优化案例</h3><ul><li>方法内联：把小方法内联到调用点，减少调用开销</li><li>去虚拟化：单态调用点变成直接调用</li><li>逃逸分析：对象不逃逸线程时做栈上分配或标量替换</li><li>锁消除/锁粗化：删除无竞争锁或合并锁</li><li>循环优化：展开、范围检查消除</li></ul><h3 id=反优化deoptimization>反优化（Deoptimization）</h3><p>JIT依赖运行时假设（比如类型单态）。当假设失效：</p><ul><li>触发反优化，已编译代码回退到解释器</li><li>重新收集运行时信息后再编译</li></ul><h2 id=cpu与调度视角>CPU与调度视角</h2><h3 id=从cpu视角理解执行流程>从CPU视角理解执行流程</h3><p>从CPU的角度看，核心是“取指 -> 译码 -> 执行”，JVM做的是把字节码尽快变成CPU能执行的本地指令，并利用硬件特性提升吞吐。</p><ul><li>解释执行：解释器每次读取字节码并分发到对应处理逻辑，本质上是“字节码解释器在CPU上运行”。CPU执行的是解释器的机器码，不是Java逻辑的机器码。</li><li>JIT编译：热点方法被编译为本地机器码后，CPU就直接执行这些指令，省掉了解释分发的开销。</li><li>指令缓存与分支预测：JIT生成的紧凑、内联后的机器码更利于I-Cache命中与分支预测，减少流水线停顿。</li><li>反优化切换：当运行时假设失效，CPU重新回到解释器或新的机器码版本，类似“代码路径切换”。</li></ul><p>一句话理解：JVM在运行时把高层字节码不断“降级/升级”为CPU更容易高效执行的指令序列。</p><h3 id=jvm层面的cpu调度视角>JVM层面的CPU调度视角</h3><p>需要区分两类线程模型：</p><ul><li>传统Java线程（平台线程）：HotSpot采用1:1映射，每个Java线程对应一个OS线程，CPU时间片主要由操作系统调度器分配。JVM能做的主要是创建/销毁线程、设置优先级（只是调度提示，效果依赖OS）。</li><li>虚拟线程（JDK 21+）：JVM内部做M:N调度，虚拟线程由JVM调度到少量“载体线程”上运行，遇到阻塞点可自动让出载体线程，提高CPU利用率。</li></ul><p>JVM内部还有一些“系统线程”，它们也会参与CPU竞争：</p><ul><li>GC线程：并行/并发回收时占用CPU</li><li>编译线程：JIT后台编译热点方法</li><li>信号、采样、监控等辅助线程</li></ul><p>关键调度时刻：</p><ul><li>安全点（Safepoint）：JVM需要让所有线程到达安全点后再进行某些全局操作（如STW GC），此时会短暂停止应用线程</li><li>反优化切换：编译代码回退解释器或切换新版本机器码，线程会在安全点或调用边界完成切换</li></ul><blockquote><p>安全点是什么
安全点（Safepoint）是 Java 程序执行过程中的一些特殊位置。在这些位置，线程的状态是确定的，JVM 可以安全地暂停所有线程，来执行一些“破坏性”的操作。</p><p>最常见的比喻是：高速公路上的服务区。汽车（线程）不能在路中间随时停下，必须开到指定的服务区（安全点）才能停下来休息或加油（GC）。</p><p><strong>为什么需要安全点</strong></p><ul><li>GC 需要做“可达性分析”，线程持续改引用会让分析失真。</li><li>反优化（Deoptimization）需要在可控点切换执行模式。</li><li>偏向锁撤销、线程转储等全局操作也需要一致状态。</li></ul><p><strong>安全点通常放在哪里</strong></p><ul><li>循环末尾（避免长循环迟迟不进安全点）。</li><li>方法返回前或调用之后。</li><li>抛出异常的位置。</li></ul><p><strong>线程如何进入安全点</strong></p><ul><li>JVM 设置全局“安全点标志位”（常见做法是让特定内存页不可读）。</li><li>线程在轮询点检查标志位，发现已设置就主动挂起。</li></ul><p><strong>无法主动轮询的线程</strong></p><ul><li>Sleep 或 Block：已经处于安全状态，醒来前会先检查 GC 是否结束。</li><li>JNI：Native 代码不操作 Java 对象，但返回 Java 前必须先进入安全点等待。</li></ul><p><strong>安全区域（Safe Region）</strong></p><ul><li>指一段引用关系不会变化的代码片段。</li><li>线程在安全区域内可直接被视为“已进入安全点”。</li></ul></blockquote><p>一句话理解：JVM自身不“直接调度CPU”，更多是通过线程模型与安全点机制协调执行，真正的CPU时间片分配主要由OS完成；虚拟线程是JVM层“主动调度”的典型例外。</p><h2 id=运行期监控与排查建议>运行期监控与排查建议</h2><ul><li>观察类加载：<code>-XX:+TraceClassLoading</code></li><li>观察JIT：<code>-XX:+PrintCompilation</code></li><li>查看GC：<code>-Xlog:gc*</code>（JDK9+）</li></ul><h2 id=相关知识>相关知识</h2><h3 id=被动引用不会初始化与懒加载实现>被动引用不会初始化与懒加载实现</h3><p>简单来说，JVM 对类初始化的原则是：<strong>不到万不得已，绝不进行初始化。</strong></p><p>之所以被称为“被动引用”，是因为它们在 JVM 规范中并未达到触发 <code>&lt;clinit></code> 方法执行的特定阈值。</p><p>以下是被动引用不会初始化深层逻辑的拆解：</p><h4 id=通过数组引用类-someclass>通过数组引用类 (<code>SomeClass[]</code>)</h4><p>当你创建一个数组对象时，例如 <code>SomeClass[] arr = new SomeClass[10];</code>，真正被初始化的类并不是 <code>SomeClass</code>，而是由 JVM 自动生成的、代表<strong>数组维度</strong>的一个特殊类（通常以 <code>[L...</code> 开头）。</p><ul><li><strong>原因</strong>：数组空间的分配只需要知道引用类型的大小，而不需要了解类内部的具体逻辑（如静态变量的赋值）。</li><li><strong>本质</strong>：你创建的是一个“容器”，而不是容器里的“内容”。只有当你真正 <code>new SomeClass()</code> 时，该类才会被初始化。</li></ul><blockquote><p>这个以 [ 开头的类，实际上是 Java 虚拟机在运行期间动态生成的一个“影子类”。</p><p>它是 JVM 用来管理数组的一种特殊类型。</p><p><strong>数组类的命名规则</strong></p><ul><li>数组类名由 JVM 内部规则生成，不是源码里的普通类名。</li><li><code>[</code> 表示数组，<code>L</code> 表示引用类型元素，<code>;</code> 结束类名。</li><li>例子：<ul><li><code>String[]</code> -> <code>[Ljava.lang.String;</code></li><li><code>int[]</code> -> <code>[I</code>（基本类型有专门缩写）</li><li><code>Object[][]</code> -> <code>[[Ljava.lang.Object;</code></li></ul></li></ul><p><strong>为什么不会触发 SomeClass 初始化</strong>
当执行 <code>SomeClass[] arr = new SomeClass[10];</code> 时，JVM 的动作是：</p><ul><li>确认类型：需要一个存储 <code>SomeClass</code> 引用的容器。</li><li>创建数组类：动态创建 <code>[LSomeClass;</code>，该类继承 <code>Object</code> 并实现 <code>Cloneable</code>、<code>Serializable</code>。</li><li>分配空间：在堆中为引用分配连续空间。</li><li>初始化默认值：所有位置设为 <code>null</code>。</li></ul><p>关键点：JVM 只是“量尺寸”和“划地盘”，不需要了解 <code>SomeClass</code> 的内部实现，因此不会触发它的静态初始化。</p><p><strong>这个“特殊类”里有什么</strong></p><ul><li>隐藏的 <code>length</code> 字段。</li><li>数组相关字节码指令支持，如 <code>aaload</code>、<code>aastore</code>。</li><li>所有数组类的直接父类都是 <code>java.lang.Object</code>。</li></ul><p>有趣的事实：打印 <code>new SomeClass[10].getClass().getName()</code>，可以看到 <code>[L...</code> 这样的名字。</p><p><strong>什么时候 SomeClass 才会初始化</strong>
只有当你真正触碰数组内部内容时：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>arr</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SomeClass</span><span class=p>();</span><span class=w> </span><span class=c1>// 实例化触发初始化</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>SomeClass</span><span class=p>.</span><span class=na>staticMethod</span><span class=p>();</span><span class=w> </span><span class=c1>// 调用静态方法触发</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>SomeClass</span><span class=p>.</span><span class=na>staticField</span><span class=p>);</span><span class=w> </span><span class=c1>// 访问非编译期常量触发</span><span class=w>
</span></span></span></code></pre></div></blockquote><h4 id=访问-static-final-编译期常量>访问 <code>static final</code> 编译期常量</h4><p>这里的关键点在于<strong>编译期（Compile Time）</strong>。</p><ul><li><strong>常量传播优化</strong>：如果一个静态字段被 <code>final</code> 修饰，并且在编译阶段就能确定其值（例如 <code>public static final int MAX = 100;</code>），那么在编译阶段，这个常量的值就会直接存储在调用方类的<strong>常量池</strong>中。</li><li><strong>本质</strong>：对于 JVM 来说，调用方实际上是在访问自己家里的副本，它甚至不知道这个值最初是从哪个类里来的。因此，原类完全没有必要初始化。</li></ul><blockquote><p><strong>注意</strong>：如果 <code>static final</code> 的值需要运行时才能确定（例如 <code>public static final int RANDOM = new Random().nextInt();</code>），那么这种情况下依然<strong>会</strong>触发初始化。</p></blockquote><h4 id=仅获取-class-对象如-someclassclass>仅获取 Class 对象（如 <code>SomeClass.class</code>）</h4><p>使用 <code>SomeClass.class</code> 获取字面量常量，或者使用某些特定的反射方法（如 <code>ClassLoader.loadClass()</code>）时，不会触发初始化。</p><ul><li><strong>原因</strong>：获取 <code>Class</code> 对象只需要完成<strong>加载</strong>（Loading）阶段，将磁盘上的字节码读入内存并生成方法区的数据结构即可。</li><li><strong>本质</strong>：初始化是类生命周期的最后一步。JVM 允许你先“认识”这个类（获取其结构信息），等到你真的准备调用它的静态方法或创建其实例时，再执行具体的初始化逻辑。</li></ul><h4 id=总结对照表>总结对照表</h4><table><thead><tr><th>触发动作</th><th>涉及阶段</th><th>是否执行 <code>&lt;clinit></code></th></tr></thead><tbody><tr><td><code>new SomeClass()</code></td><td>加载 -> 验证 -> 准备 -> 解析 -> <strong>初始化</strong></td><td><strong>是</strong></td></tr><tr><td><code>SomeClass.class</code></td><td>加载 -> 验证 -> 准备</td><td>否</td></tr><tr><td><code>SomeClass[] arr</code></td><td>初始化数组类，不涉及 <code>SomeClass</code></td><td>否</td></tr><tr><td>访问编译期常量</td><td>直接从常量池取值</td><td>否</td></tr></tbody></table><p>你可以把初始化想象成一个“开业典礼”。获取 <code>Class</code> 对象只是“看了一眼招牌”，创建数组只是“租下了地皮”，访问常量则是“买了店里印在外面的宣传单”。只有当你想进店消费（实例化）或者找店长谈话（调用静态方法）时，开业典礼才会正式举行。</p><p>简单来说，<strong>类的初始化是实现“懒加载”（Lazy Loading）的核心底层机制。</strong></p><p>在 Java 中，懒加载的本质就是：<strong>将对象的创建或某些逻辑的执行，推迟到相关类被“主动引用”而触发初始化那一刻。</strong></p><p>以下是它们之间深度绑定的逻辑：</p><h4 id=初始化的被动性支撑了懒加载>初始化的“被动性”支撑了懒加载</h4><p>正如我们之前讨论的，JVM 只有在“万不得已”时才会初始化一个类。这种特性天然地支持了懒加载模式。</p><ul><li><strong>加载（Loading）</strong>：把类信息放进内存（还没开始干活）。</li><li><strong>初始化（Initialization）</strong>：真正执行静态变量赋值和 <code>static</code> 块。</li><li><strong>关联</strong>：如果你代码里写了某个类，但从未真正调用它的构造函数、静态方法或非编译期常量，这个类就永远停留在“加载”阶段而不会“初始化”。这就节省了内存和启动时间。</li></ul><h4 id=经典案例静态内部类单例模式>经典案例：静态内部类单例模式</h4><p>这是利用类初始化机制实现懒加载最优雅的方案。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Singleton</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=nf>Singleton</span><span class=p>()</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 静态内部类</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>Holder</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=n>INSTANCE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Singleton</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=nf>getInstance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Holder</span><span class=p>.</span><span class=na>INSTANCE</span><span class=p>;</span><span class=w> </span><span class=c1>// 只有执行到这里，Holder 类才会被初始化</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ul><li><strong>为什么是懒加载？</strong> 当外部类 <code>Singleton</code> 被加载时，内部类 <code>Holder</code> 并不会被加载。只有当有人调用 <code>getInstance()</code> 并访问 <code>Holder.INSTANCE</code> 时，JVM 才会发现：<em>“噢，Holder 类还没初始化，现在得开始了。”</em></li><li><strong>为什么线程安全？</strong> 虚拟机会保证一个类的 <code>&lt;clinit></code> 方法在多线程环境中被正确地加锁和同步。如果多个线程同时初始化一个类，只有一个线程会执行初始化，其他线程阻塞等待。</li></ul><h4 id=初始化与懒加载的权衡>初始化与懒加载的权衡</h4><p>虽然懒加载能优化启动性能，但也带了一些副作用：</p><table><thead><tr><th>维度</th><th>立即初始化 (Eager)</th><th>懒加载 (Lazy)</th></tr></thead><tbody><tr><td><strong>启动速度</strong></td><td>较慢（启动时加载所有资源）</td><td>快（按需加载）</td></tr><tr><td><strong>内存占用</strong></td><td>较高（预先占坑）</td><td>较低（不用不占）</td></tr><tr><td><strong>响应性</strong></td><td>运行时调用飞快（已就绪）</td><td>第一次调用时可能有微小延迟（需初始化）</td></tr><tr><td><strong>风险</strong></td><td>错误在启动时就能发现</td><td>错误可能在运行到一半时才抛出（如 <code>NoClassDefFoundError</code>）</td></tr></tbody></table><h4 id=反射与懒加载的冲突>反射与懒加载的冲突</h4><p>反射通常会打破懒加载的优雅性。例如，如果你使用 <code>Class.forName("SomeClass")</code>，默认情况下它会强制触发 <code>SomeClass</code> 的初始化（除非你手动指定 <code>initialize = false</code>）。这就意味着，即使你还没准备好使用这个类，反射也会把它“强行唤醒”。</p><hr><h3 id=双亲委派parents-delegate>双亲委派(parents delegate)</h3><p>Java 11 仍然采用“类加载器 + 双亲委派”的经典模型，但需要注意模块化后的变化与实现细节。核心要点如下：</p><h4 id=类加载器层次java-11>类加载器层次（Java 11）</h4><ul><li><strong>Bootstrap ClassLoader</strong>：负责加载核心类库（<code>java.base</code> 等）。在实现层面是 JVM 内置的引导加载器。</li><li><strong>Platform ClassLoader</strong>：取代了旧的 Extension ClassLoader，负责加载平台类库（<code>java.*</code>、<code>javax.*</code> 中非 <code>java.base</code> 的模块）。</li><li><strong>Application ClassLoader</strong>：加载应用 classpath 或 modulepath 上的类。</li><li><strong>自定义 ClassLoader</strong>：可加载特定路径或隔离的类空间。</li></ul><h4 id=双亲委派模型>双亲委派模型</h4><p>加载流程是“先委派给父加载器，父加载器找不到再由子加载器尝试”。</p><ul><li><strong>优点</strong>：避免重复加载、确保核心类库安全、维持类的唯一性。</li><li><strong>典型流程</strong>：<code>loadClass()</code> -> 先 <code>parent.loadClass()</code> -> 父失败再 <code>findClass()</code>。</li></ul><h4 id=模块化jpms带来的变化>模块化（JPMS）带来的变化</h4><p>Java 11 支持模块系统，类加载路径分为：</p><ul><li><strong>Module Path</strong>：优先于 Class Path，模块之间通过 <code>requires/exports</code> 控制可见性。</li><li><strong>Class Path</strong>：传统方式，仍然兼容。</li></ul><p>模块系统让“可见性”不再仅由类加载器决定，还受模块依赖关系约束。</p><blockquote><p>在 JDK 8 时代，我们可以通过往 jre/lib/ext 挪动 JAR 包来扩展 Java 的功能，但在 JDK 11/23 这种现代 Java 中，扩展机制（Extension Mechanism）已经被彻底移除。</p><p>为什么不再允许扩展 lib/modules？主要有三个核心原因：</p><ul><li>性能优化：lib/modules 是以 jimage 格式存储的。JVM 启动时使用预计算哈希进行快速定位，随意塞文件会破坏这一优化。</li><li>强封装性：模块化强调边界清晰，外部 JAR 混入核心镜像可能绕过安全检查。</li><li>可靠性：避免“Classpath 地狱”，所有依赖需在启动前通过 <code>--module-path</code> 明确声明。</li></ul><p><strong>推荐方式：<code>--module-path</code></strong></p><ul><li>把 JAR 包放在任意目录下，启动时显式指定 module path。</li><li>这些类由 <code>AppClassLoader</code> 加载，地位与 lib/modules 内类平等，但物理位置分离。</li></ul></blockquote><div class=mermaid-block data-mermaid-zoom=1><div class=mermaid-toolbar><button class=mermaid-btn type=button data-action=zoom-in aria-label="Zoom in">+</button>
<button class=mermaid-btn type=button data-action=zoom-out aria-label="Zoom out">-</button>
<button class=mermaid-btn type=button data-action=reset aria-label="Reset zoom">100%</button>
<button class=mermaid-btn type=button data-action=fullscreen aria-label="Toggle fullscreen">Full</button></div><div class="mermaid mermaid-canvas">sequenceDiagram
autonumber
participant App as Application ClassLoader
participant Platform as Platform ClassLoader
participant Boot as Bootstrap Loader
participant MP as Module Path
participant CP as Class Path
App->>Platform: loadClass(name)
Platform->>Boot: loadClass(name)
Boot-->>Platform: not found
Platform-->>App: not found
App->>MP: findClass(name)
alt module exists and readable
MP-->>App: class bytes
App-->>App: defineClass
else fall back
App->>CP: findClass(name)
CP-->>App: class bytes
App-->>App: defineClass
end</div></div><h4 id=解析与链接时机>解析与链接时机</h4><p>类加载包含：加载（Loading）-> 验证（Verification）-> 准备（Preparation）-> 解析（Resolution）-> 初始化（Initialization）。</p><ul><li><strong>解析可延迟</strong>：JVM 可能在首次使用时才解析符号引用（惰性解析）。</li><li><strong>初始化是按需触发</strong>：只有“主动使用”才会执行 <code>&lt;clinit></code>。</li></ul><h4 id=常见打破委派的场景>常见“打破委派”的场景</h4><ul><li><strong>SPI/ServiceLoader</strong>：由子加载器加载实现类，父加载器加载接口，通常依赖上下文类加载器（TCCL）。</li><li><strong>容器化环境</strong>：如应用服务器、插件系统，为隔离不同应用使用自定义类加载器。</li></ul><blockquote><p>参考 <a href=https://docs.osgi.org/javadoc/r4v43/core/org/osgi/framework/Bundle.html>https://docs.osgi.org/javadoc/r4v43/core/org/osgi/framework/Bundle.html</a></p></blockquote><ul><li><strong>热部署/隔离</strong>：通过不同 ClassLoader 实现版本隔离。</li></ul><h4 id=上下文类加载器tccl>上下文类加载器（TCCL）</h4><p>为了解决“父加载器看不到子加载器资源”的问题，Java 引入了线程上下文类加载器：</p><ul><li>默认是 <code>Application ClassLoader</code>。</li><li>框架（如 JDBC、JNDI、SPI）常用 TCCL 来加载实现类。</li></ul><h4 id=类卸载与元空间>类卸载与元空间</h4><ul><li>类卸载发生在对应的 <code>ClassLoader</code> 不可达且无存活类实例时。</li><li>元空间（Metaspace）存放类元数据，GC 可回收对应空间。</li></ul><h4 id=java-11-常见观察手段>Java 11 常见观察手段</h4><ul><li><code>-XX:+TraceClassLoading</code>：观察类加载</li><li><code>-XX:+TraceClassUnloading</code>：观察类卸载</li><li><code>-Xlog:class+load=info</code>：JDK 9+ 统一日志系统</li></ul></article><div id=react-app-components data-post-id=7967d6ad533d9bb6e95ccef98f268671></div><button class=mobile-toc-trigger aria-controls=mobile-toc aria-expanded=false title=Index>☰</button><div class=mobile-toc-overlay hidden></div><div id=mobile-toc class=mobile-toc-drawer aria-hidden=true role=dialog aria-label=Index><div class=mobile-toc-header><button class=mobile-toc-close aria-label=close>×</button></div><nav class=mobile-toc-body><div class=mobile-toc-list></div></nav><div class=mobile-safe-area-spacer></div></div><script type=module src=/react/page.bundle.js></script></main><footer><div class=copyright><small>Made with <span style=color:#e25555>&#9829;</span> in Guangzhou by
©<a href=https://github.com/qtopie>qtopie</a> 2026
</small><small>Posts licensed under <a href=https://creativecommons.org/licenses/by/4.0/legalcode>CC BY 4.0</small></div><div><script type=module src=/react/base.bundle.js></script><script type=module>
      (async ()=>{
        try {
          const mod = await import('https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.mjs');
          const mermaid = mod.default || mod;
          const prefersDark = document.body.classList.contains('dark') || window.matchMedia('(prefers-color-scheme: dark)').matches;
          mermaid.initialize({ startOnLoad: false, theme: prefersDark ? 'dark' : 'default' });
          mermaid.init && mermaid.init(undefined, document.querySelectorAll('.mermaid'));

          const clamp = (value, min, max) => Math.min(max, Math.max(min, value));
          const setupBlock = (block) => {
            if (block.dataset.mermaidReady === 'true') return;
            block.dataset.mermaidReady = 'true';
            const canvas = block.querySelector('.mermaid-canvas');
            const toolbar = block.querySelector('.mermaid-toolbar');
            if (!canvas || !toolbar) return;

            const ensureSvg = (callback) => {
              const svg = canvas.querySelector('svg');
              if (svg) { callback(svg); return; }
              const observer = new MutationObserver(() => {
                const svgNow = canvas.querySelector('svg');
                if (svgNow) {
                  observer.disconnect();
                  callback(svgNow);
                }
              });
              observer.observe(canvas, { childList: true, subtree: true });
            };

            const setZoom = (nextZoom) => {
              const zoom = clamp(nextZoom, 0.5, 3);
              block.dataset.mermaidZoom = String(zoom);
              const resetBtn = toolbar.querySelector('[data-action="reset"]');
              if (resetBtn) resetBtn.textContent = `${Math.round(zoom * 100)}%`;
              ensureSvg((svg) => {
                svg.style.transform = `scale(${zoom})`;
              });
            };

            const onFullscreenChange = () => {
              const isFullscreen = document.fullscreenElement === block;
              block.classList.toggle('is-fullscreen', isFullscreen);
              const fsBtn = toolbar.querySelector('[data-action="fullscreen"]');
              if (fsBtn) {
                fsBtn.textContent = isFullscreen ? 'Exit' : 'Full';
                fsBtn.setAttribute('aria-label', isFullscreen ? 'Exit fullscreen' : 'Enter fullscreen');
              }
            };

            document.addEventListener('fullscreenchange', onFullscreenChange);

            toolbar.addEventListener('click', (event) => {
              const target = event.target;
              if (!(target instanceof HTMLElement)) return;
              const action = target.getAttribute('data-action');
              if (!action) return;
              const currentZoom = Number(block.dataset.mermaidZoom || '1');
              if (action === 'zoom-in') return setZoom(currentZoom + 0.1);
              if (action === 'zoom-out') return setZoom(currentZoom - 0.1);
              if (action === 'reset') return setZoom(1);
              if (action === 'fullscreen') {
                if (document.fullscreenElement === block) {
                  document.exitFullscreen && document.exitFullscreen();
                } else if (block.requestFullscreen) {
                  block.requestFullscreen();
                } else {
                  block.classList.toggle('is-fullscreen');
                }
              }
            });

            setZoom(Number(block.dataset.mermaidZoom || '1'));
          };

          document.querySelectorAll('.mermaid-block').forEach(setupBlock);
        } catch (e) { console.error('mermaid load error', e); }
      })();
    </script></div></footer></body></html>