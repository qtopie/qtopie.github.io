<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>eBPF | 1001問</title><link rel=stylesheet href=/css/main.min.dcb41abaa5ea2698ebf89f814bc6b8060470b6414061437dac2ee0e3ef5d3b45.css integrity="sha256-3LQauqXqJpjr+J+BS8a4BgRwtkFAYUN9rC7g4+9dO0U=" crossorigin=anonymous><link rel=stylesheet href=/css/page.min.81d92e4ce9b8dc4e8a2018a7aee70f76bd7fb6884d929d5fd74e3f959f06e2f5.css integrity="sha256-gdkuTOm43E6KIBinrucPdr1/tohNkp1f104/lZ8G4vU=" crossorigin=anonymous><link rel=stylesheet href=/css/syntax.min.e114b8cc38f57d520f373580c935a518bc6afd6dec4f1d682365cdbcf5c8218a.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css crossorigin=anonymous referrerpolicy=no-referrer><script src=/js/toc.min.87636f25caf644980403a5c1ce8b0812cfd10d1e53c08f181547966799ceccdb.js integrity="sha256-h2NvJcr2RJgEA6XBzosIEs/RDR5TwI8YFUeWZ5nOzNs=" crossorigin=anonymous type=module defer></script><script src=/js/copy-code.min.3bea0de4cfe8670f94a5d75c177f07b58fc90178efdea7f2a21449798d75b2c9.js integrity="sha256-O+oN5M/oZw+UpddcF38HtY/JAXjv3qfyohRJeY11ssk=" crossorigin=anonymous defer></script><script defer src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script defer src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js crossorigin=anonymous referrerpolicy=no-referrer onload='renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],throwOnError:!1})'></script><script src=/js/katex-block.min.2cf531bbcc318aadf5661baa2d0987ab5cb4daef473e108b1da714a37cff0b25.js integrity="sha256-LPUxu8wxiq31ZhuqLQmHq1y02u9HPhCLHacUo3z/CyU=" crossorigin=anonymous defer></script></head><body><header><nav><a href=/><h1>1001問</h1></a><div id=react-search class=search-root aria-label="Site Search"></div></nav></header><main><div class=sidebar><section class=toc><nav id=TableOfContents><ul><li><a href=#ebpf介绍>eBPF介绍</a><ul><li><a href=#ebpf动态扩展了哪些内核能力>eBPF动态扩展了哪些内核能力</a></li></ul></li><li><a href=#如何使用>如何使用</a><ul><li><a href=#ebpf工作流程>eBPF工作流程</a></li><li><a href=#一个加速小例子>一个加速小例子</a></li></ul></li><li><a href=#参考>参考</a></li></ul></nav></section></div><article id=content><div class=metadata><h1>eBPF</h1><time datetime=2026-01-25T00:00:00+00:00>January 25, 2026</time><div class=taxonomy><span id=post-categories><ul><li><strong>Categories</strong>:&nbsp;</li><li class=category-item><a href=https://qtopie.github.io/categories/linux>linux</a></li><li class=category-item><a href=https://qtopie.github.io/categories/network>network</a></li></ul></span><span id=post-tags><ul><li><strong>Tags</strong>:&nbsp;</li><li class=tag-item><a href=https://qtopie.github.io/tags/ebpf><em>eBPF</em></a></li></ul></span></div></div><h2 id=ebpf介绍>eBPF介绍</h2><p>eBPF（Extended Berkeley Packet Filter）允许开发者在不修改内核源码、不加载内核模块的情况下，把小段受控程序安全地运行在内核里。它通过沙盒虚拟机让内核变得可编程，广泛用于网络、安全、可观测性等场景。</p><p><img src=ebpf.png alt="What is eBPF"></p><p><strong>核心工作原理</strong></p><ul><li>事件驱动：挂载在系统调用、网络包收发、Tracepoint 或 kprobe/uprobes 等钩子上。</li><li>安全验证：加载前先过 Verifier 检查，避免崩溃、死循环或越界访问。</li><li>JIT 编译：通过 JIT 将字节码转成原生指令，性能接近内核代码。</li><li>数据交互：通过 Map（键值存储）在内核态与用户态共享数据。</li></ul><p><strong>主要应用场景</strong></p><ul><li>网络加速与负载均衡：例如 Cilium 用 eBPF 做高性能容器网络和安全路由。</li><li>可观测性：低开销系统调用跟踪、性能剖析、链路监控，无需改应用代码。</li><li>运行时安全：拦截异常系统调用，实现细粒度防火墙或策略控制。</li></ul><p><strong>优势对比</strong></p><table><thead><tr><th>特性</th><th>eBPF 程序</th><th>内核模块</th><th>修改内核源码</th></tr></thead><tbody><tr><td>安全性</td><td>Verifier 保底，避免崩溃</td><td>代码错误可能导致死机</td><td>风险最高</td></tr><tr><td>灵活性</td><td>动态加载/卸载，无需重启</td><td>加载复杂，易引入依赖</td><td>需要编译并重启</td></tr><tr><td>性能</td><td>JIT 后接近原生</td><td>高</td><td>高</td></tr></tbody></table><p>如需开始开发，可参考 <a href=https://ebpf.io/>ebpf.io</a> 文档，或使用 BCC、libbpf 等工具链。</p><h3 id=ebpf动态扩展了哪些内核能力>eBPF动态扩展了哪些内核能力</h3><ol><li><strong>深度可观测性与性能剖析 (Observability & Profiling)</strong></li></ol><ul><li>无侵入跟踪：挂载到 kprobes/uprobes/tracepoints，实时监控函数或系统调用。</li><li>低成本性能监控：采集指令周期、内存、热点函数，几乎零额外开销。</li><li>内核态聚合：先在内核过滤/统计，只把结果送到用户态，减少数据拷贝。</li></ul><ol start=2><li><strong>高性能网络处理 (Networking)</strong></li></ol><ul><li>XDP 旁路：在网卡驱动层直接处理包，可做 DDoS 防护、负载均衡、防火墙。</li><li>容器网络：为 Kubernetes Pod 提供高效路由，绕过大量 iptables 规则。</li><li>自定义协议：在内核态解析非标准协议，无需回到用户态再处理。</li></ul><ol start=3><li><strong>动态安全控制 (Security)</strong></li></ol><ul><li>行为审计：监控异常访问（如读取 /etc/shadow），触发告警或阻断。</li><li>细粒度策略：可限制特定进程只能访问某些 IP/目录。</li><li>流量脱敏：在内核态做 TLS 卸载或敏感字段脱敏。</li></ul><ol start=4><li><strong>现代内核调度与扩展 (Kernel Evolution)</strong></li></ol><ul><li>自定义调度：借助 sched_ext，针对 AI 训练、音视频等场景写专用调度策略。</li><li>热补丁：无需重启即可挂载 eBPF 程序修补已知逻辑缺陷。</li></ul><h2 id=如何使用>如何使用</h2><h3 id=ebpf工作流程>eBPF工作流程</h3><div class=mermaid>graph TD
subgraph User_Space ["用户态 (User Space)"]
A["编写 eBPF 源代码<br>(C / Rust)"] -- "LLVM / Clang" --> B["eBPF 字节码<br>(Bytecode)"]
B -- "bpf 系统调用" --> C["加载并注入内核"]
L["eBPF Maps<br>共享存储/键值对"] --- M["用户态控制程序<br>Go / C++ / Rust"]
M -- "分析数据" --> N["可视化 / 控制面板"]
end
subgraph Kernel_Space ["内核态 (Kernel Space)"]
C --> D{"验证器 Verifier<br>安全/权限检查"}
D -- "拒绝" --> E["报错并停止加载"]
D -- "通过" --> F["JIT 即时编译器"]
F --> G["原生机器码<br>Native Machine Code"]
subgraph Hooks ["事件钩子 (Event Hooks)"]
H["网络包 XDP/TC"]
I["系统调用 Syscalls"]
J["内核函数 Kprobes"]
K["用户函数 Uprobes"]
end
G -- "挂载执行" --> H
G -- "挂载执行" --> I
G -- "挂载执行" --> J
G -- "挂载执行" --> K
H & I & J & K -- "数据交互" --> L
end
style D fill:#f96,stroke:#333,stroke-width:2px
style G fill:#00d2ff,stroke:#333,stroke-width:2px
style L fill:#fff4dd,stroke:#d4a017,stroke-width:2px</div><h3 id=一个加速小例子>一个加速小例子</h3><p>场景：为局域网内的平板/手机做游戏加速。思路是：数据包进入网关后，如果源 MAC 在“加速名单”且目标 IP 在“游戏服务器列表”，则把流量指派给本地代理端口（示例中用 1080），否则直连。</p><p>为了方便开发，使用 Go 版本的 Cilium eBPF SDK。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// accelerator.c
</span></span></span><span class=line><span class=cl><span class=c1>// +build ignore
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/bpf.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/if_ether.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/ip.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/tcp.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;bpf/bpf_helpers.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;bpf/bpf_endian.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 存储需要加速的设备 MAC
</span></span></span><span class=line><span class=cl><span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>__uint</span><span class=p>(</span><span class=n>type</span><span class=p>,</span> <span class=n>BPF_MAP_TYPE_HASH</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>__uint</span><span class=p>(</span><span class=n>max_entries</span><span class=p>,</span> <span class=mi>128</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>__type</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>char</span><span class=p>[</span><span class=mi>6</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>__type</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>__u32</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>acc_macs</span> <span class=nf>SEC</span><span class=p>(</span><span class=s>&#34;.maps&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 存储游戏服务器 IP
</span></span></span><span class=line><span class=cl><span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>__uint</span><span class=p>(</span><span class=n>type</span><span class=p>,</span> <span class=n>BPF_MAP_TYPE_HASH</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>__uint</span><span class=p>(</span><span class=n>max_entries</span><span class=p>,</span> <span class=mi>1024</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>__type</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>__u32</span><span class=p>);</span> <span class=c1>// 目标 IP
</span></span></span><span class=line><span class=cl>    <span class=nf>__type</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>__u32</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>game_ips</span> <span class=nf>SEC</span><span class=p>(</span><span class=s>&#34;.maps&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>SEC</span><span class=p>(</span><span class=s>&#34;tc&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>fast_game_assign</span><span class=p>(</span><span class=k>struct</span> <span class=n>__sk_buff</span> <span class=o>*</span><span class=n>skb</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=o>*</span><span class=n>data</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)(</span><span class=kt>long</span><span class=p>)</span><span class=n>skb</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=o>*</span><span class=n>data_end</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)(</span><span class=kt>long</span><span class=p>)</span><span class=n>skb</span><span class=o>-&gt;</span><span class=n>data_end</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>ethhdr</span> <span class=o>*</span><span class=n>eth</span> <span class=o>=</span> <span class=n>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)(</span><span class=n>eth</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>data_end</span><span class=p>)</span> <span class=k>return</span> <span class=n>TC_ACT_OK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 1. 过滤 MAC 地址
</span></span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>bpf_map_lookup_elem</span><span class=p>(</span><span class=o>&amp;</span><span class=n>acc_macs</span><span class=p>,</span> <span class=n>eth</span><span class=o>-&gt;</span><span class=n>h_source</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>TC_ACT_OK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>eth</span><span class=o>-&gt;</span><span class=n>h_proto</span> <span class=o>!=</span> <span class=nf>bpf_htons</span><span class=p>(</span><span class=n>ETH_P_IP</span><span class=p>))</span> <span class=k>return</span> <span class=n>TC_ACT_OK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>iphdr</span> <span class=o>*</span><span class=n>ip</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)(</span><span class=n>eth</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)(</span><span class=n>ip</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>data_end</span><span class=p>)</span> <span class=k>return</span> <span class=n>TC_ACT_OK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 2. 过滤游戏服务器 IP
</span></span></span><span class=line><span class=cl>    <span class=n>__u32</span> <span class=n>dest_ip</span> <span class=o>=</span> <span class=n>ip</span><span class=o>-&gt;</span><span class=n>daddr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>bpf_map_lookup_elem</span><span class=p>(</span><span class=o>&amp;</span><span class=n>game_ips</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>dest_ip</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>// 3. 核心：查找本地监听 12345 端口的 TCP Socket
</span></span></span><span class=line><span class=cl>        <span class=c1>// 注意：这里 tuple 需要匹配包的方向
</span></span></span><span class=line><span class=cl>        <span class=k>struct</span> <span class=n>bpf_sock_tuple</span> <span class=n>tuple</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>        <span class=n>tuple</span><span class=p>.</span><span class=n>ipv4</span><span class=p>.</span><span class=n>daddr</span> <span class=o>=</span> <span class=n>ip</span><span class=o>-&gt;</span><span class=n>daddr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>tuple</span><span class=p>.</span><span class=n>ipv4</span><span class=p>.</span><span class=n>saddr</span> <span class=o>=</span> <span class=n>ip</span><span class=o>-&gt;</span><span class=n>saddr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 假设加速器监听在本地 12345 端口
</span></span></span><span class=line><span class=cl>        <span class=c1>// 在实际逻辑中，我们会查找具体监听该地址的 socket
</span></span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>struct</span> <span class=n>bpf_sock</span> <span class=o>*</span><span class=n>sk</span> <span class=o>=</span> <span class=nf>bpf_sk_lookup_tcp</span><span class=p>(</span><span class=n>skb</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>tuple</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>tuple</span><span class=p>.</span><span class=n>ipv4</span><span class=p>),</span> <span class=n>BPF_F_NETNS</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>sk</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 将数据包指派给该 Socket，后续协议栈将不再匹配其他监听者
</span></span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nf>bpf_sk_assign</span><span class=p>(</span><span class=n>skb</span><span class=p>,</span> <span class=n>sk</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nf>bpf_sk_release</span><span class=p>(</span><span class=n>sk</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>TC_ACT_OK</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nf>bpf_sk_release</span><span class=p>(</span><span class=n>sk</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>TC_ACT_OK</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=n>_license</span><span class=p>[]</span> <span class=nf>SEC</span><span class=p>(</span><span class=s>&#34;license&#34;</span><span class=p>)</span> <span class=o>=</span> <span class=s>&#34;GPL&#34;</span><span class=p>;</span>
</span></span></code></pre></div><ul><li>main.go</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nx>main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;log&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;net&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;os&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;os/signal&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;syscall&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;github.com/cilium/ebpf&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;github.com/cilium/ebpf/link&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;github.com/cilium/ebpf/rlimit&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// 使用 bpf2go 自动生成 Go 代码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=cp>//go:generate go run github.com/cilium/ebpf/cmd/bpf2go -target bpf bpf accelerator.c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// 1. 移除内核内存限制（旧内核需要）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>rlimit</span><span class=p>.</span><span class=nf>RemoveMemlock</span><span class=p>();</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// 2. 加载编译好的 eBPF 对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>objs</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>bpfObjects</span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>loadBpfObjects</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>objs</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>);</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;loading objects: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>defer</span><span class=w> </span><span class=nx>objs</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// 3. 设置加速名单</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// 手机 MAC 地址</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>mac</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>net</span><span class=p>.</span><span class=nf>ParseMAC</span><span class=p>(</span><span class=s>&#34;AA:BB:CC:DD:EE:FF&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>var</span><span class=w> </span><span class=nx>macKey</span><span class=w> </span><span class=p>[</span><span class=mi>6</span><span class=p>]</span><span class=kt>byte</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>copy</span><span class=p>(</span><span class=nx>macKey</span><span class=p>[:],</span><span class=w> </span><span class=nx>mac</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>objs</span><span class=p>.</span><span class=nx>AccMacs</span><span class=p>.</span><span class=nf>Put</span><span class=p>(</span><span class=nx>macKey</span><span class=p>,</span><span class=w> </span><span class=nb>uint32</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// 游戏服务器 IP (例如 1.2.3.4)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>gameIP</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>net</span><span class=p>.</span><span class=nf>ParseIP</span><span class=p>(</span><span class=s>&#34;1.2.3.4&#34;</span><span class=p>).</span><span class=nf>To4</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>objs</span><span class=p>.</span><span class=nx>GameIps</span><span class=p>.</span><span class=nf>Put</span><span class=p>(</span><span class=nx>gameIP</span><span class=p>,</span><span class=w> </span><span class=nb>uint32</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// 4. 获取网卡接口 (树莓派通常是 eth0 或 wlan0)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>iface</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>net</span><span class=p>.</span><span class=nf>InterfaceByName</span><span class=p>(</span><span class=s>&#34;eth0&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;lookup network iface: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// 5. 挂载到 TCX 钩子 (Linux 6.6+ 最佳性能)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>l</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>link</span><span class=p>.</span><span class=nf>AttachTCX</span><span class=p>(</span><span class=nx>link</span><span class=p>.</span><span class=nx>TCXOptions</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>Interface</span><span class=p>:</span><span class=w> </span><span class=nx>iface</span><span class=p>.</span><span class=nx>Index</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>Program</span><span class=p>:</span><span class=w>   </span><span class=nx>objs</span><span class=p>.</span><span class=nx>FastGameAssign</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>Attach</span><span class=p>:</span><span class=w>    </span><span class=nx>ebpf</span><span class=p>.</span><span class=nx>AttachTCXIngress</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// 如果内核版本较低不支持 TCX，则回退到传统 TC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;failed to attach TCX: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>defer</span><span class=w> </span><span class=nx>l</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;树莓派加速器启动成功！已挂载至 %s\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>iface</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;监听 MAC: AA:BB:CC:DD:EE:FF -&gt; 游戏服务器 IP: 1.2.3.4&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// 6. 等待退出信号</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>stop</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span><span class=w> </span><span class=nx>os</span><span class=p>.</span><span class=nx>Signal</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>signal</span><span class=p>.</span><span class=nf>Notify</span><span class=p>(</span><span class=nx>stop</span><span class=p>,</span><span class=w> </span><span class=nx>os</span><span class=p>.</span><span class=nx>Interrupt</span><span class=p>,</span><span class=w> </span><span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGTERM</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=o>&lt;-</span><span class=nx>stop</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>运行要点</strong></p><ul><li>MAC、IP 与代理端口都需替换为你的实际环境；示例仅演示流程。</li><li>bpf_sk_lookup_tcp/bpf_sk_assign 需要 CAP_BPF + CAP_NET_ADMIN 权限。</li><li>如果内核版本不支持 TCX，可改用 <code>link.AttachTC</code> 作为兜底。</li></ul><p><strong>树莓派环境依赖</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt update
</span></span><span class=line><span class=cl>sudo apt install clang llvm libelf-dev libbpf-dev golang -y
</span></span></code></pre></div><p><strong>为什么这是树莓派的最佳方案？</strong></p><ul><li>CPU 负载低：在 Ingress 即完成分流，无需复杂 Netfilter 匹配。</li><li>内存占用小：eBPF Map 查询是常数级别的 (O(1))。</li><li>业务透明：终端无感知，无需装 App 或改 DNS。</li></ul><p>注意：建议内核 5.10+。若想使用 TCX（性能更好），需要 6.6+ 内核，例如 Debian 13 (Trixie) 预览或自编译新内核。</p><h2 id=参考>参考</h2><ul><li><a href=https://ebpf.io/>eBPF</a></li><li><a href=https://ebpf-go.dev/guides/getting-started/>eBPF GO</a></li></ul>&lt;&lt;&lt;&lt;&lt;&lt;&lt; Updated upstream<div id=react-app-components data-post-id=274815576fbe4fea34a6e69a843716a1></div>=======
>>>>>>> Stashed changes</article><div id=react-single-actions data-post-id=274815576fbe4fea34a6e69a843716a1></div>&lt;&lt;&lt;&lt;&lt;&lt;&lt; Updated upstream
<button class=mobile-toc-trigger aria-controls=mobile-toc aria-expanded=false title=Index>☰</button><div class=mobile-toc-overlay hidden></div><div id=mobile-toc class=mobile-toc-drawer aria-hidden=true role=dialog aria-label=Index><div class=mobile-toc-header><button class=mobile-toc-close aria-label=close>×</button></div><nav class=mobile-toc-body><div class=mobile-toc-list></div></nav><div class=mobile-safe-area-spacer></div></div>=======
<link rel=stylesheet href=/react/alphatab/alphaTab.css>>>>>>>> Stashed changes
<script type=module src=/react/page.bundle.js></script></main><footer><div class=copyright><small>Made with <span style=color:#e25555>&#9829;</span> in Guangzhou by
©<a href=https://github.com/qtopie>qtopie</a> 2026
</small><small>Posts licensed under <a href=https://creativecommons.org/licenses/by/4.0/legalcode>CC BY 4.0</small></div><div><script type=module src=/react/base.bundle.js></script><script type=module>
      (async ()=>{
        try {
          const mod = await import('https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.mjs');
          const mermaid = mod.default || mod;
          const prefersDark = document.body.classList.contains('dark') || window.matchMedia('(prefers-color-scheme: dark)').matches;
          mermaid.initialize({ startOnLoad: false, theme: prefersDark ? 'dark' : 'default' });
          mermaid.init && mermaid.init(undefined, document.querySelectorAll('.mermaid'));
        } catch (e) { console.error('mermaid load error', e); }
      })();
    </script></div></footer></body></html>