<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>eBPF | 1001問</title><link rel=stylesheet href=/css/main.min.dcb41abaa5ea2698ebf89f814bc6b8060470b6414061437dac2ee0e3ef5d3b45.css integrity="sha256-3LQauqXqJpjr+J+BS8a4BgRwtkFAYUN9rC7g4+9dO0U=" crossorigin=anonymous><link rel=stylesheet href=/css/page.min.81d92e4ce9b8dc4e8a2018a7aee70f76bd7fb6884d929d5fd74e3f959f06e2f5.css integrity="sha256-gdkuTOm43E6KIBinrucPdr1/tohNkp1f104/lZ8G4vU=" crossorigin=anonymous><link rel=stylesheet href=/css/syntax.min.e114b8cc38f57d520f373580c935a518bc6afd6dec4f1d682365cdbcf5c8218a.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css crossorigin=anonymous referrerpolicy=no-referrer><script src=/js/toc.min.87636f25caf644980403a5c1ce8b0812cfd10d1e53c08f181547966799ceccdb.js integrity="sha256-h2NvJcr2RJgEA6XBzosIEs/RDR5TwI8YFUeWZ5nOzNs=" crossorigin=anonymous type=module defer></script><script src=/js/copy-code.min.3bea0de4cfe8670f94a5d75c177f07b58fc90178efdea7f2a21449798d75b2c9.js integrity="sha256-O+oN5M/oZw+UpddcF38HtY/JAXjv3qfyohRJeY11ssk=" crossorigin=anonymous defer></script><script defer src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script defer src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js crossorigin=anonymous referrerpolicy=no-referrer onload='renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],throwOnError:!1})'></script><script src=/js/katex-block.min.2cf531bbcc318aadf5661baa2d0987ab5cb4daef473e108b1da714a37cff0b25.js integrity="sha256-LPUxu8wxiq31ZhuqLQmHq1y02u9HPhCLHacUo3z/CyU=" crossorigin=anonymous defer></script></head><body><header><nav><a href=/><h1>1001問</h1></a><div id=react-search class=search-root aria-label="Site Search"></div></nav></header><main><div class=sidebar><section class=toc><nav id=TableOfContents><ul><li><a href=#ebpf介绍>eBPF介绍</a><ul><li><a href=#核心工作原理>核心工作原理</a></li><li><a href=#ebpf动态扩展了哪些内核能力>eBPF动态扩展了哪些内核能力</a></li></ul></li><li><a href=#如何使用>如何使用</a><ul><li><a href=#ebpf工作流程>eBPF工作流程</a></li><li><a href=#一个加速小例子>一个加速小例子</a></li></ul></li><li><a href=#参考>参考</a></li></ul></nav></section></div><article id=content><div class=metadata><h1>eBPF</h1><time datetime=2026-01-25T00:00:00+00:00>January 25, 2026</time><div class=taxonomy><span id=post-categories><ul><li><strong>Categories</strong>:&nbsp;</li><li class=category-item><a href=https://qtopie.github.io/categories/linux>linux</a></li><li class=category-item><a href=https://qtopie.github.io/categories/network>network</a></li></ul></span><span id=post-tags><ul><li><strong>Tags</strong>:&nbsp;</li><li class=tag-item><a href=https://qtopie.github.io/tags/ebpf><em>eBPF</em></a></li></ul></span></div></div><h2 id=ebpf介绍>eBPF介绍</h2><p>eBPF（Extended Berkeley Packet Filter）是一种革命性的内核技术，允许开发者在不修改内核源代码、不加载内核模块的情况下，在操作系统内核中安全、高效地运行自定义程序。
它通过在内核中运行一个沙盒虚拟机，使内核变得可编程，广泛应用于网络、安全、可观测性等领域。</p><p><img src=ebpf.png alt="What is eBPF"></p><h3 id=核心工作原理>核心工作原理</h3><p>事件驱动：eBPF 程序通常挂载在特定的“钩子”（Hook）上，如系统调用、网络包收发、内核跟踪点（Tracepoint）或动态探测点（kprobes/uprobes）。
安全验证：程序加载前会经过内核验证器（Verifier）的严格检查，确保程序不会崩溃、不会陷入死循环，也不会非法访问内核内存。
JIT 编译：经过验证的字节码通过即时编译（JIT）转换为原生的机器指令，其执行效率接近原生内核代码。
数据交互：eBPF 程序通过 Maps（键值对存储）与用户空间进行数据共享，实现监控结果的实时传输或配置的动态更新。</p><p>主要应用场景
网络加速与负载均衡：例如 Cilium 利用 eBPF 实现高性能的容器网络和安全路由。
可观测性：在无需修改应用代码的情况下，实现极低开销的系统调用跟踪、性能剖析和链路监控。
运行时安全：实时拦截异常的系统调用，实施细粒度的防火墙规则或安全策略。</p><p>优势对比
特性 eBPF 程序 内核模块 (Kernel Module) 修改内核源码
安全性 内核验证器保证不崩溃 错误可能导致系统蓝屏/死机 风险最高
灵活性 动态加载/卸载，无需重启 加载复杂，易引入依赖问题 需要编译并重启内核
性能 高（JIT 编译后接近原生） 高 高
如需开始开发，可以参考 ebpf.io 提供的文档，或使用 BCC (BPF Compiler Collection) 和 libbpf 等工具链</p><h3 id=ebpf动态扩展了哪些内核能力>eBPF动态扩展了哪些内核能力</h3><ol><li>深度可观测性与性能剖析 (Observability & Profiling)
eBPF 可以无死角地观察内核和应用的运行状态，且几乎没有性能损耗。
函数与系统调用跟踪：通过挂载到 kprobes（内核函数）、uprobes（用户空间函数）或 tracepoints（静态跟踪点），实时监控每一次系统调用或函数执行。
零侵入性能监控：无需修改应用代码（无须重新编译或注入代理），即可采集 CPU 指令周期、内存使用率及函数调用热点图。
低开销数据聚合：在内核态直接对数据进行过滤和统计，只将最终结果传给用户态，避免了大量原始数据拷贝带来的开销。</li><li>高性能网络处理 (Networking)
通过接管内核协议栈的关键路径，eBPF 极大地提升了网络吞吐量并降低了延迟。
绕过标准协议栈 (XDP)：在网卡驱动层（XDP）直接处理数据包，实现极速的 DDoS 防护、负载均衡和防火墙过滤。
容器网络与服务网格：在 Kubernetes 等云原生场景中，eBPF 可实现 Pod 间的高效路由，甚至直接绕过传统的 iptables 规则以优化网络路径。
自定义协议解析：支持在内核态直接解析非标准或自定义的网络协议，无需将包传回用户空间处理。</li><li>动态安全控制 (Security)
eBPF 充当了内核级的“安全警卫”，能够实时识别并拦截恶意行为。
运行时行为审计：监控异常的进程行为（如异常读取 /etc/shadow 文件），并触发警报或直接终止该操作。
细粒度权限管控：不仅能看（审计），还能干预。例如限制特定进程仅能访问特定的 IP 或文件目录。
加密与脱敏：实时监控敏感数据流，在内核态自动执行 TLS 卸载或对传输中的敏感数据进行脱敏处理。</li><li>现代内核调度与扩展 (Kernel Evolution)
到 2026 年，eBPF 的能力已进一步深入到内核的核心调度逻辑。
自定义 CPU 调度：通过 sched_ext 等框架，开发者可以编写自定义的 CPU 调度策略，针对特定工作负载（如 AI 训练或实时音视频）优化计算资源的分配。
热补丁与功能修复：在不重启系统的情况下，通过挂载 eBPF 程序动态修复已知的内核逻辑缺陷或漏洞。</li></ol><h2 id=如何使用>如何使用</h2><h3 id=ebpf工作流程>eBPF工作流程</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>graph TD
</span></span><span class=line><span class=cl>    subgraph User_Space [&#34;用户态 (User Space)&#34;]
</span></span><span class=line><span class=cl>        A[&#34;编写 eBPF 源代码&lt;br/&gt;(C / Rust)&#34;] -- &#34;LLVM / Clang&#34; --&gt; B[&#34;eBPF 字节码&lt;br/&gt;(Bytecode)&#34;]
</span></span><span class=line><span class=cl>        B -- &#34;bpf 系统调用&#34; --&gt; C[&#34;加载并注入内核&#34;]
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        L[&#34;eBPF Maps&lt;br/&gt;共享存储/键值对&#34;] --- M[&#34;用户态控制程序&lt;br/&gt;Go / C++ / Rust&#34;]
</span></span><span class=line><span class=cl>        M -- &#34;分析数据&#34; --&gt; N[&#34;可视化 / 控制面板&#34;]
</span></span><span class=line><span class=cl>    end
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    subgraph Kernel_Space [&#34;内核态 (Kernel Space)&#34;]
</span></span><span class=line><span class=cl>        C --&gt; D{&#34;验证器 Verifier&lt;br/&gt;安全/权限检查&#34;}
</span></span><span class=line><span class=cl>        D -- &#34;拒绝&#34; --&gt; E[&#34;报错并停止加载&#34;]
</span></span><span class=line><span class=cl>        D -- &#34;通过&#34; --&gt; F[&#34;JIT 即时编译器&#34;]
</span></span><span class=line><span class=cl>        F --&gt; G[&#34;原生机器码&lt;br/&gt;Native Machine Code&#34;]
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        subgraph Hooks [&#34;事件钩子 (Event Hooks)&#34;]
</span></span><span class=line><span class=cl>            H[&#34;网络包 XDP/TC&#34;]
</span></span><span class=line><span class=cl>            I[&#34;系统调用 Syscalls&#34;]
</span></span><span class=line><span class=cl>            J[&#34;内核函数 Kprobes&#34;]
</span></span><span class=line><span class=cl>            K[&#34;用户函数 Uprobes&#34;]
</span></span><span class=line><span class=cl>        end
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        G -- &#34;挂载执行&#34; --&gt; H
</span></span><span class=line><span class=cl>        G -- &#34;挂载执行&#34; --&gt; I
</span></span><span class=line><span class=cl>        G -- &#34;挂载执行&#34; --&gt; J
</span></span><span class=line><span class=cl>        G -- &#34;挂载执行&#34; --&gt; K
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        H &amp; I &amp; J &amp; K -- &#34;数据交互&#34; --&gt; L
</span></span><span class=line><span class=cl>    end
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    style D fill:#f96,stroke:#333,stroke-width:2px
</span></span><span class=line><span class=cl>    style G fill:#00d2ff,stroke:#333,stroke-width:2px
</span></span><span class=line><span class=cl>    style L fill:#fff4dd,stroke:#d4a017,stroke-width:2px
</span></span></code></pre></div><h3 id=一个加速小例子>一个加速小例子</h3><p>现在假定一个业务场景，比如我们想实现给局域网里的部分设备如平板/手机游戏加速，其工作流程为
当手机流量到达网关时，根据手机MAC地址和请求的域名/IP对应指定游戏的服务时，就转发到加速端口进行加速，否则就走直连。</p><p>假定我们接收加速流量的端口使用了sock5代理为1080</p><p>为了方便开发，我们可以使用GO版本的SDK来实现 <a href=https://github.com/cilium/ebpf>https://github.com/cilium/ebpf</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// accelerator.c
</span></span></span><span class=line><span class=cl><span class=c1>// +build ignore
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/bpf.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/if_ether.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/ip.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/tcp.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;bpf/bpf_helpers.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;bpf/bpf_endian.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 存储需要加速的设备 MAC
</span></span></span><span class=line><span class=cl><span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>__uint</span><span class=p>(</span><span class=n>type</span><span class=p>,</span> <span class=n>BPF_MAP_TYPE_HASH</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>__uint</span><span class=p>(</span><span class=n>max_entries</span><span class=p>,</span> <span class=mi>128</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>__type</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>char</span><span class=p>[</span><span class=mi>6</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>__type</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>__u32</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>acc_macs</span> <span class=nf>SEC</span><span class=p>(</span><span class=s>&#34;.maps&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 存储游戏服务器 IP
</span></span></span><span class=line><span class=cl><span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>__uint</span><span class=p>(</span><span class=n>type</span><span class=p>,</span> <span class=n>BPF_MAP_TYPE_HASH</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>__uint</span><span class=p>(</span><span class=n>max_entries</span><span class=p>,</span> <span class=mi>1024</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>__type</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>__u32</span><span class=p>);</span> <span class=c1>// 目标 IP
</span></span></span><span class=line><span class=cl>    <span class=nf>__type</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>__u32</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>game_ips</span> <span class=nf>SEC</span><span class=p>(</span><span class=s>&#34;.maps&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>SEC</span><span class=p>(</span><span class=s>&#34;tc&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>fast_game_assign</span><span class=p>(</span><span class=k>struct</span> <span class=n>__sk_buff</span> <span class=o>*</span><span class=n>skb</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=o>*</span><span class=n>data</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)(</span><span class=kt>long</span><span class=p>)</span><span class=n>skb</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=o>*</span><span class=n>data_end</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)(</span><span class=kt>long</span><span class=p>)</span><span class=n>skb</span><span class=o>-&gt;</span><span class=n>data_end</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>ethhdr</span> <span class=o>*</span><span class=n>eth</span> <span class=o>=</span> <span class=n>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)(</span><span class=n>eth</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>data_end</span><span class=p>)</span> <span class=k>return</span> <span class=n>TC_ACT_OK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 1. 过滤 MAC 地址
</span></span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>bpf_map_lookup_elem</span><span class=p>(</span><span class=o>&amp;</span><span class=n>acc_macs</span><span class=p>,</span> <span class=n>eth</span><span class=o>-&gt;</span><span class=n>h_source</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>TC_ACT_OK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>eth</span><span class=o>-&gt;</span><span class=n>h_proto</span> <span class=o>!=</span> <span class=nf>bpf_htons</span><span class=p>(</span><span class=n>ETH_P_IP</span><span class=p>))</span> <span class=k>return</span> <span class=n>TC_ACT_OK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>iphdr</span> <span class=o>*</span><span class=n>ip</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)(</span><span class=n>eth</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)(</span><span class=n>ip</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>data_end</span><span class=p>)</span> <span class=k>return</span> <span class=n>TC_ACT_OK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 2. 过滤游戏服务器 IP
</span></span></span><span class=line><span class=cl>    <span class=n>__u32</span> <span class=n>dest_ip</span> <span class=o>=</span> <span class=n>ip</span><span class=o>-&gt;</span><span class=n>daddr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>bpf_map_lookup_elem</span><span class=p>(</span><span class=o>&amp;</span><span class=n>game_ips</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>dest_ip</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>// 3. 核心：查找本地监听 12345 端口的 TCP Socket
</span></span></span><span class=line><span class=cl>        <span class=c1>// 注意：这里 tuple 需要匹配包的方向
</span></span></span><span class=line><span class=cl>        <span class=k>struct</span> <span class=n>bpf_sock_tuple</span> <span class=n>tuple</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>        <span class=n>tuple</span><span class=p>.</span><span class=n>ipv4</span><span class=p>.</span><span class=n>daddr</span> <span class=o>=</span> <span class=n>ip</span><span class=o>-&gt;</span><span class=n>daddr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>tuple</span><span class=p>.</span><span class=n>ipv4</span><span class=p>.</span><span class=n>saddr</span> <span class=o>=</span> <span class=n>ip</span><span class=o>-&gt;</span><span class=n>saddr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 假设加速器监听在本地 12345 端口
</span></span></span><span class=line><span class=cl>        <span class=c1>// 在实际逻辑中，我们会查找具体监听该地址的 socket
</span></span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>struct</span> <span class=n>bpf_sock</span> <span class=o>*</span><span class=n>sk</span> <span class=o>=</span> <span class=nf>bpf_sk_lookup_tcp</span><span class=p>(</span><span class=n>skb</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>tuple</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>tuple</span><span class=p>.</span><span class=n>ipv4</span><span class=p>),</span> <span class=n>BPF_F_NETNS</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>sk</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 将数据包指派给该 Socket，后续协议栈将不再匹配其他监听者
</span></span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nf>bpf_sk_assign</span><span class=p>(</span><span class=n>skb</span><span class=p>,</span> <span class=n>sk</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nf>bpf_sk_release</span><span class=p>(</span><span class=n>sk</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>TC_ACT_OK</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nf>bpf_sk_release</span><span class=p>(</span><span class=n>sk</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>TC_ACT_OK</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=n>_license</span><span class=p>[]</span> <span class=nf>SEC</span><span class=p>(</span><span class=s>&#34;license&#34;</span><span class=p>)</span> <span class=o>=</span> <span class=s>&#34;GPL&#34;</span><span class=p>;</span>
</span></span></code></pre></div><ul><li>main.go</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nx>main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;log&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;net&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;os&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;os/signal&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;syscall&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;://github.com&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;://github.com/link&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;://github.com/rlimit&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// 使用 bpf2go 自动生成 Go 代码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=cp>//go:generate go run ://github.com/cmd/bpf2go -target bpf bpf accelerator.c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// 1. 移除内核内存限制（旧内核需要）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>rlimit</span><span class=p>.</span><span class=nf>RemoveMemlock</span><span class=p>();</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// 2. 加载编译好的 eBPF 对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>objs</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>bpfObjects</span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>loadBpfObjects</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>objs</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>);</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;loading objects: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>defer</span><span class=w> </span><span class=nx>objs</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// 3. 设置加速名单</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// 手机 MAC 地址</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>mac</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>net</span><span class=p>.</span><span class=nf>ParseMAC</span><span class=p>(</span><span class=s>&#34;AA:BB:CC:DD:EE:FF&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>var</span><span class=w> </span><span class=nx>macKey</span><span class=w> </span><span class=p>[</span><span class=mi>6</span><span class=p>]</span><span class=kt>byte</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>copy</span><span class=p>(</span><span class=nx>macKey</span><span class=p>[:],</span><span class=w> </span><span class=nx>mac</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>objs</span><span class=p>.</span><span class=nx>AccMacs</span><span class=p>.</span><span class=nf>Put</span><span class=p>(</span><span class=nx>macKey</span><span class=p>,</span><span class=w> </span><span class=nb>uint32</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// 游戏服务器 IP (例如 1.2.3.4)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>gameIP</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>net</span><span class=p>.</span><span class=nf>ParseIP</span><span class=p>(</span><span class=s>&#34;1.2.3.4&#34;</span><span class=p>).</span><span class=nf>To4</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>objs</span><span class=p>.</span><span class=nx>GameIps</span><span class=p>.</span><span class=nf>Put</span><span class=p>(</span><span class=nx>gameIP</span><span class=p>,</span><span class=w> </span><span class=nb>uint32</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// 4. 获取网卡接口 (树莓派通常是 eth0 或 wlan0)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>iface</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>net</span><span class=p>.</span><span class=nf>InterfaceByName</span><span class=p>(</span><span class=s>&#34;eth0&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;lookup network iface: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// 5. 挂载到 TCX 钩子 (Linux 6.6+ 最佳性能)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>l</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>link</span><span class=p>.</span><span class=nf>AttachTCX</span><span class=p>(</span><span class=nx>link</span><span class=p>.</span><span class=nx>TCXOptions</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>Interface</span><span class=p>:</span><span class=w> </span><span class=nx>iface</span><span class=p>.</span><span class=nx>Index</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>Program</span><span class=p>:</span><span class=w>   </span><span class=nx>objs</span><span class=p>.</span><span class=nx>FastGameAssign</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>Attach</span><span class=p>:</span><span class=w>    </span><span class=nx>ebpf</span><span class=p>.</span><span class=nx>AttachTCXIngress</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// 如果内核版本较低不支持 TCX，则回退到传统 TC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;failed to attach TCX: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>defer</span><span class=w> </span><span class=nx>l</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;树莓派加速器启动成功！已挂载至 %s\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>iface</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;监听 MAC: AA:BB:CC:DD:EE:FF -&gt; 游戏服务器 IP: 1.2.3.4&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// 6. 等待退出信号</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>stop</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span><span class=w> </span><span class=nx>os</span><span class=p>.</span><span class=nx>Signal</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>signal</span><span class=p>.</span><span class=nf>Notify</span><span class=p>(</span><span class=nx>stop</span><span class=p>,</span><span class=w> </span><span class=nx>os</span><span class=p>.</span><span class=nx>Interrupt</span><span class=p>,</span><span class=w> </span><span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGTERM</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=o>&lt;-</span><span class=nx>stop</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>假如我们在树莓派上运行，我们需要准备以下环境依赖</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt update
</span></span><span class=line><span class=cl>sudo apt install clang llvm libelf-dev libbpf-dev golang -y
</span></span></code></pre></div><p>为什么这是树莓派的最佳方案？</p><ul><li><p>CPU 负载极低：在网卡驱动刚收到包的时刻（Ingress）就完成了分流，数据包不需要经过复杂的 Netfilter 规则匹配。</p></li><li><p>内存占用极小：eBPF Map 的查询是常数级别的 (O(1)) 时间复杂度。</p></li><li><p>全透明：手机端完全无感，不需要安装任何 App，也不需要改 DNS。</p></li></ul><p>注意： 运行此程序需要 Linux 内核版本建议在 5.10 以上，若要使用最新的 TCX 钩子，建议树莓派系统升级至最新的 Debian 13 (Trixie) 预览版或定制的 6.6+ 内核。</p><h2 id=参考>参考</h2><ul><li><a href=https://ebpf.io/>eBPF</a></li><li><a href=https://ebpf-go.dev/guides/getting-started/>eBPF GO</a></li></ul><div id=react-single-actions data-post-id=274815576fbe4fea34a6e69a843716a1></div></article><button class=mobile-toc-trigger aria-controls=mobile-toc aria-expanded=false title=Index>☰</button><div class=mobile-toc-overlay hidden></div><div id=mobile-toc class=mobile-toc-drawer aria-hidden=true role=dialog aria-label=Index><div class=mobile-toc-header><button class=mobile-toc-close aria-label=close>×</button></div><nav class=mobile-toc-body><div class=mobile-toc-list></div></nav><div class=mobile-safe-area-spacer></div></div><script type=module src=/react/page.bundle.js></script></main><footer><div class=copyright><small>Made with <span style=color:#e25555>&#9829;</span> in Guangzhou by
©<a href=https://github.com/qtopie>qtopie</a> 2026
</small><small>Posts licensed under <a href=https://creativecommons.org/licenses/by/4.0/legalcode>CC BY 4.0</small></div><div><script type=module src=/react/base.bundle.js></script></div></footer></body></html>