<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>Ubuntu init process | 1001問</title><link rel=stylesheet href=/css/main.min.dcb41abaa5ea2698ebf89f814bc6b8060470b6414061437dac2ee0e3ef5d3b45.css integrity="sha256-3LQauqXqJpjr+J+BS8a4BgRwtkFAYUN9rC7g4+9dO0U=" crossorigin=anonymous><link rel=stylesheet href=/css/home.min.5ac5664053c6ff57052d1e509e7cc9b36e8f9835b7c93b096da215d0725e106e.css integrity="sha256-WsVmQFPG/1cFLR5QnnzJs26PmDW3yTsJbaIV0HJeEG4=" crossorigin=anonymous></head><body><header><nav><a href=/><h1>1001問</h1></a><div id=react-search class=search-root aria-label="Site Search"></div></nav></header><main><div class=sidebar><section class=toc><h2>Table Of Contents</h2><nav id=TableOfContents><ul><li><a href=#history>History</a><ul><li><a href=#features-of-upstart>Features of Upstart</a></li></ul></li><li><a href=#systemd>Systemd</a><ul><li><a href=#systemctl>systemctl</a></li><li><a href=#init-script-vs-service-file>Init script vs Service file</a></li></ul></li><li><a href=#reference>Reference</a></li></ul></nav></section></div><article id=content><div class=metadata><h1>Ubuntu init process</h1><time datetime=2016-09-15T14:20:15+08:00>September 15, 2016</time><div class=taxonomy><span id=post-categories><ul><li><strong>Categories</strong>:&nbsp;</li><li class=category-item><a href=https://qtopie.github.io/categories/linux>linux</a></li></ul></span><span id=post-tags><ul><li><strong>Tags</strong>:&nbsp;</li><li class=tag-item><a href=https://qtopie.github.io/tags/ubuntu><em>ubuntu</em></a></li></ul></span></div></div><h2 id=history>History</h2><ul><li>sysVinit</li><li><a href=http://upstart.ubuntu.com/>upstart</a></li><li>systemd</li></ul><p>ubuntu: sysVinit &ndash;> upstart(6.10+) &ndash;> systemd (15.04+)</p><h3 id=features-of-upstart>Features of Upstart</h3><p><em>Event Based</em></p><ul><li>Start System faster (compare with previous method).</li><li>Dynamically start service when discovering new device</li><li>Dynamically stop service when device is removed</li></ul><h2 id=systemd>Systemd</h2><p>Systemd is a collection of system management daemons, utilities and libraries which serves as a replacement of System V init daemon. Systemd functions as
central management and configuration platform for UNIX like system.</p><h3 id=systemctl>systemctl</h3><p>Systemctl is a systemd utility which is responsible for Controlling the systemd system and service manager.</p><h3 id=init-script-vs-service-file>Init script vs Service file</h3><p>You may use <code>service SCRIPT start|stop|statu..</code> manage jobs, but it&rsquo;s different
between using Init script and upstart or systemd service file.
<em>see <code>man service</code></em>.</p><h4 id=system-v-init-script>System V init script</h4><p>located in /etc/init.d/SCRIPT</p><ul><li>Example: (from shadowsocks-go project)</li></ul><pre tabindex=0><code>#!/bin/bash
# Start/stop shadowsocks.
#
### BEGIN INIT INFO
# Provides:          shadowsocks
# Required-Start:
# Required-Stop:
# Should-Start:
# Should-Stop:
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: shadowsocks is a lightweight tunneling proxy
# Description:       Modified from Linode&#39;s nginx fastcgi startup script
### END INIT INFO

# Note: this script requires sudo in order to run shadowsocks as the specified
# user. 

BIN=/usr/bin/shadowsocks-local
CONFIG_FILE=/etc/shadowsocks/config.json
LOG_FILE=/var/log/shadowsocks
USER=nobody
GROUP=nobody
PID_DIR=/var/run
PID_FILE=$PID_DIR/shadowsocks.pid
RET_VAL=0

[ -x $BIN ] || exit 0

check_running() {
  if [[ -r $PID_FILE ]]; then
    read PID &lt;$PID_FILE
    if [[ -d &#34;/proc/$PID&#34; ]]; then
      return 0
    else
      rm -f $PID_FILE
      return 1
    fi
  else
    return 2
  fi
}

do_status() {
  check_running
  case $? in
    0)
      echo &#34;shadowsocks running with PID $PID&#34;
      ;;
    1)
      echo &#34;shadowsocks not running, remove PID file $PID_FILE&#34;
      ;;
    2)
      echo &#34;Could not find PID file $PID_FILE, shadowsocks does not appear to be running&#34;
      ;;
  esac
  return 0
}

do_start() {
  if [[ ! -d $PID_DIR ]]; then
    echo &#34;creating PID dir&#34;
    mkdir $PID_DIR || echo &#34;failed creating PID directory $PID_DIR&#34;; exit 1
    chown $USER:$GROUP $PID_DIR || echo &#34;failed creating PID directory $PID_DIR&#34;; exit 1
    chmod 0770 $PID_DIR
  fi
  if check_running; then
    echo &#34;shadowsocks already running with PID $PID&#34;
    return 0
  fi
  if [[ ! -r $CONFIG_FILE ]]; then
    echo &#34;config file $CONFIG_FILE not found&#34;
    return 1
  fi
  echo &#34;starting shadowsocks&#34;
  # sudo will set the group to the primary group of $USER
  sudo -u $USER $BIN -c $CONFIG_FILE &gt;&gt;$LOG_FILE &amp;
  PID=$!
  echo $PID &gt; $PID_FILE
  sleep 0.3
  if ! check_running; then
    echo &#34;start failed&#34;
    return 1
  fi
  echo &#34;shadowsocks running with PID $PID&#34;
  return 0
}

do_stop() {
  if check_running; then
    echo &#34;stopping shadowsocks with PID $PID&#34;
    kill $PID
    rm -f $PID_FILE
  else
    echo &#34;Could not find PID file $PID_FILE&#34;
  fi
}

do_restart() {
  do_stop
  do_start
}

case &#34;$1&#34; in
  start|stop|restart|status)
    do_$1
    ;;
  *)
    echo &#34;Usage: shadowsocks {start|stop|restart|status}&#34;
    RET_VAL=1
    ;;
esac

exit $RET_VAL
</code></pre><p>You can use <code>update-rc.d</code> command to update the system service definitions.</p><h4 id=systemd-unit-file>Systemd Unit file</h4><p>Example (<code>/etc/systemd/system/shadowsocks.service</code>)</p><ol><li>Prepare the executable file with the custom service.</li><li>Create a unit file in the /etc/systemd/system/ directory and make sure it has correct file permissions. Execute as root:</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span>touch /etc/systemd/system/shadowsocks.service
</span></span><span style=display:flex><span>chmod <span style=color:#f60>644</span> /etc/systemd/system/shadowsocks.service
</span></span></code></pre></div><ol start=3><li>Edit <code>shadowsocks.service</code> file</li></ol><ul><li>Shadowsocks-local</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-systemd data-lang=systemd><span style=display:flex><span><span style=color:#069;font-weight:700>[Unit]</span>
</span></span><span style=display:flex><span><span style=color:#309>Description</span><span style=color:#555>=</span><span style=color:#c30>Shadowsocks local daemon</span>
</span></span><span style=display:flex><span><span style=color:#309>After</span><span style=color:#555>=</span><span style=color:#c30>network.target</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>[Service]</span>
</span></span><span style=display:flex><span><span style=color:#309>ExecStart</span><span style=color:#555>=</span><span style=color:#c30>/usr/bin/shadowsocks-local -c /etc/shadowsocks/config.json</span>
</span></span><span style=display:flex><span><span style=color:#309>PIDFile</span><span style=color:#555>=</span><span style=color:#c30>/var/run/shadowsocks.pid</span>
</span></span><span style=display:flex><span><span style=color:#309>KillMode</span><span style=color:#555>=</span><span style=color:#c30>process</span>
</span></span><span style=display:flex><span><span style=color:#309>Restart</span><span style=color:#555>=</span><span style=color:#c30>on-failure</span>
</span></span><span style=display:flex><span><span style=color:#309>RestartSec</span><span style=color:#555>=</span><span style=color:#c30>42s</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>[Install]</span>
</span></span><span style=display:flex><span><span style=color:#309>WantedBy</span><span style=color:#555>=</span><span style=color:#c30>default.target</span>
</span></span></code></pre></div><ul><li>Shadowsocks-server</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-systemd data-lang=systemd><span style=display:flex><span><span style=color:#a00;background-color:#faa>[Unit]</span>                                                                          
</span></span><span style=display:flex><span><span style=color:#309>Description</span><span style=color:#555>=</span><span style=color:#c30>Go Shadowsocks server daemon                                          </span>
</span></span><span style=display:flex><span><span style=color:#309>Wants</span><span style=color:#555>=</span><span style=color:#c30>network-online.target</span>
</span></span><span style=display:flex><span><span style=color:#309>After</span><span style=color:#555>=</span><span style=color:#c30>network.target network-online.target multi-user.target</span>
</span></span><span style=display:flex><span>                                                                                 
</span></span><span style=display:flex><span><span style=color:#a00;background-color:#faa>[Service]</span>                                                                        
</span></span><span style=display:flex><span><span style=color:#309>ExecStart</span><span style=color:#555>=</span><span style=color:#c30>/usr/bin/shadowsocks-server -u -c /etc/shadowsocks/config.json  </span>
</span></span><span style=display:flex><span><span style=color:#309>ExecReload</span><span style=color:#555>=</span><span style=color:#c30>/bin/kill -HUP $MAINPID</span>
</span></span><span style=display:flex><span><span style=color:#309>PIDFile</span><span style=color:#555>=</span><span style=color:#c30>/var/run/shadowsocks.pid                                                 </span>
</span></span><span style=display:flex><span><span style=color:#309>KillMode</span><span style=color:#555>=</span><span style=color:#c30>process                                                                 </span>
</span></span><span style=display:flex><span><span style=color:#309>Restart</span><span style=color:#555>=</span><span style=color:#c30>on-failure                                                               </span>
</span></span><span style=display:flex><span><span style=color:#309>TimeoutStopSec</span><span style=color:#555>=</span><span style=color:#c30>30</span>
</span></span><span style=display:flex><span>                                                                                 
</span></span><span style=display:flex><span><span style=color:#a00;background-color:#faa>[Install]</span>                                                                        
</span></span><span style=display:flex><span><span style=color:#309>WantedBy</span><span style=color:#555>=</span><span style=color:#c30>multi-user.target </span>
</span></span><span style=display:flex><span><span style=color:#309>Alias</span><span style=color:#555>=</span><span style=color:#c30>ss-server.service</span>
</span></span></code></pre></div><ul><li>Proxy setting</li></ul><pre tabindex=0><code>Environment=&#34;HTTP_PROXY=http://127.0.0.1:8118&#34;
Environment=&#34;HTTPS_PROXY=http://127.0.0.1:8118&#34;
Environment=&#34;NO_PROXY=pi.lan,127.0.0.1&#34;
</code></pre><p>Check Environment setting [example home-assistant-@pi.servie]:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl show home-assistant@pi.service --property Environment
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic># Output:</span>
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic># Environment=HTTP_PROXY=http://127.0.0.1:8118 HTTPS_PROXY=http://127.0.0.1:8118 NO_PROXY=pi.lan,127.0.0.1</span>
</span></span></code></pre></div><ol start=4><li>Notify systemd that a new shadowsocks.service file exists by executing the
following command as root</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl daemon-reload
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic># start shadowsocks service</span>
</span></span><span style=display:flex><span>systemctl start shadowsocks.service
</span></span></code></pre></div><p>You can check its status now by <code>service shadowsocks status</code>
To add it to startup, using <code>systemctl enable shadowsocks</code></p><ul><li>Check details of running status</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span>service shadowsocks status -l
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic># or</span>
</span></span><span style=display:flex><span>journalctl -xe
</span></span></code></pre></div><p><em>upstart job is configured in <code>/etc/init/</code></em></p><ol start=5><li>Shell script with systemd unit</li></ol><p><em>A sample with java web application.</em></p><p>dummy service</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-systemd data-lang=systemd><span style=display:flex><span><span style=color:#a00;background-color:#faa>[Unit]</span>                                                                          
</span></span><span style=display:flex><span><span style=color:#309>Description</span><span style=color:#555>=</span><span style=color:#c30>Dummy daemon                                          </span>
</span></span><span style=display:flex><span><span style=color:#309>Wants</span><span style=color:#555>=</span><span style=color:#c30>network-online.target</span>
</span></span><span style=display:flex><span><span style=color:#309>After</span><span style=color:#555>=</span><span style=color:#c30>network.target network-online.target multi-user.target</span>
</span></span><span style=display:flex><span>                                                                                 
</span></span><span style=display:flex><span><span style=color:#a00;background-color:#faa>[Service]</span>                                                                        
</span></span><span style=display:flex><span><span style=color:#309>ExecStart</span><span style=color:#555>=</span><span style=color:#c30>/usr/bin/dummy </span>
</span></span><span style=display:flex><span><span style=color:#309>ExecReload</span><span style=color:#555>=</span><span style=color:#c30>/bin/kill -HUP $MAINPID</span>
</span></span><span style=display:flex><span><span style=color:#309>PIDFile</span><span style=color:#555>=</span><span style=color:#c30>/var/run/dummy.pid                                                 </span>
</span></span><span style=display:flex><span><span style=color:#309>KillMode</span><span style=color:#555>=</span><span style=color:#c30>process                                                                 </span>
</span></span><span style=display:flex><span><span style=color:#309>Restart</span><span style=color:#555>=</span><span style=color:#c30>on-failure                                                               </span>
</span></span><span style=display:flex><span><span style=color:#309>TimeoutStopSec</span><span style=color:#555>=</span><span style=color:#c30>30</span>
</span></span><span style=display:flex><span>                                                                                 
</span></span><span style=display:flex><span><span style=color:#a00;background-color:#faa>[Install]</span>                                                                        
</span></span><span style=display:flex><span><span style=color:#309>WantedBy</span><span style=color:#555>=</span><span style=color:#c30>multi-user.target </span>
</span></span></code></pre></div><p>dummy script to start</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#09f;font-style:italic>#/bin/bash</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#033>JAVA_HOME</span><span style=color:#555>=</span><span style=color:#c30>&#34;</span><span style=color:#a00>${</span><span style=color:#033>JAVA_HOME</span><span style=color:#069;font-weight:700>:-</span>/usr/lib/jvm/default<span style=color:#a00>}</span><span style=color:#c30>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#033>JAVA_OPTS</span><span style=color:#555>=</span><span style=color:#c30>&#34;-XX:+UnlockExperimentalVMOptions -XX:-UseJVMCICompiler&#34;</span>
</span></span><span style=display:flex><span><span style=color:#033>JAVA_OPTS</span><span style=color:#555>=</span><span style=color:#c30>&#34;</span><span style=color:#a00>${</span><span style=color:#033>JAVA_OPTS</span><span style=color:#a00>}</span><span style=color:#c30> -Xms1024m -Xmx2048m -XX:PermSize=32m&#34;</span>
</span></span><span style=display:flex><span><span style=color:#033>DUMMY_PROGRAM</span><span style=color:#555>=</span><span style=color:#c30>&#34;/opt/dummy/dummy.jar&#34;</span>
</span></span><span style=display:flex><span><span style=color:#033>START_CMD</span><span style=color:#555>=</span><span style=color:#c30>&#34;</span><span style=color:#a00>${</span><span style=color:#033>JAVA_HOME</span><span style=color:#a00>}</span><span style=color:#c30>/bin/java </span><span style=color:#a00>${</span><span style=color:#033>JAVA_OPTS</span><span style=color:#a00>}</span><span style=color:#c30> -jar </span><span style=color:#a00>${</span><span style=color:#033>DUMMY_PROGRAM</span><span style=color:#a00>}</span><span style=color:#c30>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#033>LOG_FILE</span><span style=color:#555>=</span>/var/log/dummy
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>init<span style=color:#555>()</span> <span style=color:#555>{</span>
</span></span><span style=display:flex><span>	touch <span style=color:#a00>${</span><span style=color:#033>LOG_FILE</span><span style=color:#a00>}</span>
</span></span><span style=display:flex><span><span style=color:#555>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>check_running<span style=color:#555>()</span> <span style=color:#555>{</span>
</span></span><span style=display:flex><span>	logger -i -t <span style=color:#c30>&#34;It&#39;s running&#34;</span> -f <span style=color:#a00>${</span><span style=color:#033>LOG_FILE</span><span style=color:#a00>}</span>
</span></span><span style=display:flex><span><span style=color:#555>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>check_deps<span style=color:#555>()</span> <span style=color:#555>{</span>
</span></span><span style=display:flex><span>	<span style=color:#366>echo</span> <span style=color:#c30>&#34;Ok&#34;</span>
</span></span><span style=display:flex><span><span style=color:#555>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>start<span style=color:#555>()</span> <span style=color:#555>{</span>
</span></span><span style=display:flex><span>	<span style=color:#366>eval</span> <span style=color:#a00>${</span><span style=color:#033>START_CMD</span><span style=color:#a00>}</span>
</span></span><span style=display:flex><span>	<span style=color:#366>echo</span> <span style=color:#c30>&#34;It&#39;s started&#34;</span>		
</span></span><span style=display:flex><span><span style=color:#555>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>main<span style=color:#555>()</span> <span style=color:#555>{</span>
</span></span><span style=display:flex><span> init
</span></span><span style=display:flex><span> check_running
</span></span><span style=display:flex><span> check_deps
</span></span><span style=display:flex><span> start &amp;
</span></span><span style=display:flex><span><span style=color:#555>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>main <span style=color:#c30>&#34;</span><span style=color:#033>$@</span><span style=color:#c30>&#34;</span>
</span></span></code></pre></div><h2 id=reference>Reference</h2><ul><li><a href=https://wiki.ubuntu.com/systemd>https://wiki.ubuntu.com/systemd</a></li><li><a href=https://wiki.debian.org/Debate/initsystem/sysvinit>https://wiki.debian.org/Debate/initsystem/sysvinit</a></li><li><a href=http://0pointer.de/public/systemd-man/>http://0pointer.de/public/systemd-man/</a></li><li><a href=https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/sect-Managing_Services_with_systemd-Unit_Files.html>https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/sect-Managing_Services_with_systemd-Unit_Files.html</a></li><li><a href=https://home-assistant.io/docs/autostart/systemd/>https://home-assistant.io/docs/autostart/systemd/</a></li></ul><div id=react-single-actions data-post-id=d0571fda140d7a0f4149a60b792d1645></div></article><script type=module>

const toc = document.querySelector('#TableOfContents');
if (toc) {
  
  toc.addEventListener('click', (e) => {
    const a = e.target.closest('a');
    if (!a) return;
    const id = a.getAttribute('href')?.replace('#','');
    const target = id ? document.getElementById(id) : null;
    if (target) {
      e.preventDefault();
      target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      history.replaceState(null, '', `#${id}`);
    }
  });

  
  const headings = Array.from(document.querySelectorAll('article h1, article h2, article h3, article h4'));
  const linkMap = new Map();
  for (const a of toc.querySelectorAll('a[href^="#"]')) {
    const id = a.getAttribute('href').slice(1);
    linkMap.set(id, a);
  }

  const setActive = (id) => {
    for (const a of linkMap.values()) a.classList.remove('is-active');
    const active = linkMap.get(id);
    if (active) active.classList.add('is-active');
  };

  const observer = new IntersectionObserver((entries) => {
    
    const visible = entries
      .filter(e => e.isIntersecting)
      .sort((a, b) => a.target.getBoundingClientRect().top - b.target.getBoundingClientRect().top);
    if (visible.length) {
      const id = visible[0].target.id;
      if (id) setActive(id);
    }
  }, {
    root: null,
    rootMargin: '-96px 0px -60% 0px', 
    threshold: [0, 1e-3, 0.25]
  });

  headings.forEach(h => {
    
    if (!h.id) {
      h.id = h.textContent.trim().toLowerCase().replace(/\s+/g, '-');
    }
    observer.observe(h);
  });

  
  if (location.hash) {
    const target = document.getElementById(location.hash.slice(1));
    if (target) {
      setTimeout(() => target.scrollIntoView({ behavior: 'smooth', block: 'start' }), 0);
    }
  }
}
</script><script type=module src=/react/page.bundle.js></script></main><footer><div class=copyright><small>Made with <span style=color:#e25555>&#9829;</span> in Guangzhou by
©<a href=https://github.com/qtopie>qtopie</a> 2026
</small><small>Posts licensed under <a href=https://creativecommons.org/licenses/by/4.0/legalcode>CC BY 4.0</small></div><div><script type=module src=/react/base.bundle.js></script></div></footer></body></html>