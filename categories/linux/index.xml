<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Linux on 1001問</title><link>https://qtopie.github.io/categories/linux/</link><description>Recent content in Linux on 1001問</description><generator>Hugo</generator><language>en-us</language><copyright>Posts licensed under &lt;a href="https://creativecommons.org/licenses/by/4.0/legalcode"&gt;CC BY 4.0</copyright><lastBuildDate>Sun, 25 Jan 2026 00:00:00 +0000</lastBuildDate><atom:link href="https://qtopie.github.io/categories/linux/index.xml" rel="self" type="application/rss+xml"/><item><title>eBPF</title><link>https://qtopie.github.io/notes/linux/ebpf/</link><pubDate>Sun, 25 Jan 2026 00:00:00 +0000</pubDate><guid>https://qtopie.github.io/notes/linux/ebpf/</guid><description>&lt;h2 id="ebpf介绍"&gt;eBPF介绍&lt;/h2&gt;
&lt;p&gt;eBPF（Extended Berkeley Packet Filter）允许开发者在不修改内核源码、不加载内核模块的情况下，把小段受控程序安全地运行在内核里。它通过沙盒虚拟机让内核变得可编程，广泛用于网络、安全、可观测性等场景。&lt;/p&gt;
&lt;p&gt;&lt;img src="ebpf.png" alt="What is eBPF"&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;核心工作原理&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;事件驱动：挂载在系统调用、网络包收发、Tracepoint 或 kprobe/uprobes 等钩子上。&lt;/li&gt;
&lt;li&gt;安全验证：加载前先过 Verifier 检查，避免崩溃、死循环或越界访问。&lt;/li&gt;
&lt;li&gt;JIT 编译：通过 JIT 将字节码转成原生指令，性能接近内核代码。&lt;/li&gt;
&lt;li&gt;数据交互：通过 Map（键值存储）在内核态与用户态共享数据。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;主要应用场景&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;网络加速与负载均衡：例如 Cilium 用 eBPF 做高性能容器网络和安全路由。&lt;/li&gt;
&lt;li&gt;可观测性：低开销系统调用跟踪、性能剖析、链路监控，无需改应用代码。&lt;/li&gt;
&lt;li&gt;运行时安全：拦截异常系统调用，实现细粒度防火墙或策略控制。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;优势对比&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
 &lt;thead&gt;
 &lt;tr&gt;
 &lt;th&gt;特性&lt;/th&gt;
 &lt;th&gt;eBPF 程序&lt;/th&gt;
 &lt;th&gt;内核模块&lt;/th&gt;
 &lt;th&gt;修改内核源码&lt;/th&gt;
 &lt;/tr&gt;
 &lt;/thead&gt;
 &lt;tbody&gt;
 &lt;tr&gt;
 &lt;td&gt;安全性&lt;/td&gt;
 &lt;td&gt;Verifier 保底，避免崩溃&lt;/td&gt;
 &lt;td&gt;代码错误可能导致死机&lt;/td&gt;
 &lt;td&gt;风险最高&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;灵活性&lt;/td&gt;
 &lt;td&gt;动态加载/卸载，无需重启&lt;/td&gt;
 &lt;td&gt;加载复杂，易引入依赖&lt;/td&gt;
 &lt;td&gt;需要编译并重启&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;性能&lt;/td&gt;
 &lt;td&gt;JIT 后接近原生&lt;/td&gt;
 &lt;td&gt;高&lt;/td&gt;
 &lt;td&gt;高&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;如需开始开发，可参考 &lt;a href="https://ebpf.io/"&gt;ebpf.io&lt;/a&gt; 文档，或使用 BCC、libbpf 等工具链。&lt;/p&gt;
&lt;h3 id="ebpf动态扩展了哪些内核能力"&gt;eBPF动态扩展了哪些内核能力&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;深度可观测性与性能剖析 (Observability &amp;amp; Profiling)&lt;/strong&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;无侵入跟踪：挂载到 kprobes/uprobes/tracepoints，实时监控函数或系统调用。&lt;/li&gt;
&lt;li&gt;低成本性能监控：采集指令周期、内存、热点函数，几乎零额外开销。&lt;/li&gt;
&lt;li&gt;内核态聚合：先在内核过滤/统计，只把结果送到用户态，减少数据拷贝。&lt;/li&gt;
&lt;/ul&gt;
&lt;ol start="2"&gt;
&lt;li&gt;&lt;strong&gt;高性能网络处理 (Networking)&lt;/strong&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;XDP 旁路：在网卡驱动层直接处理包，可做 DDoS 防护、负载均衡、防火墙。&lt;/li&gt;
&lt;li&gt;容器网络：为 Kubernetes Pod 提供高效路由，绕过大量 iptables 规则。&lt;/li&gt;
&lt;li&gt;自定义协议：在内核态解析非标准协议，无需回到用户态再处理。&lt;/li&gt;
&lt;/ul&gt;
&lt;ol start="3"&gt;
&lt;li&gt;&lt;strong&gt;动态安全控制 (Security)&lt;/strong&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;行为审计：监控异常访问（如读取 /etc/shadow），触发告警或阻断。&lt;/li&gt;
&lt;li&gt;细粒度策略：可限制特定进程只能访问某些 IP/目录。&lt;/li&gt;
&lt;li&gt;流量脱敏：在内核态做 TLS 卸载或敏感字段脱敏。&lt;/li&gt;
&lt;/ul&gt;
&lt;ol start="4"&gt;
&lt;li&gt;&lt;strong&gt;现代内核调度与扩展 (Kernel Evolution)&lt;/strong&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;自定义调度：借助 sched_ext，针对 AI 训练、音视频等场景写专用调度策略。&lt;/li&gt;
&lt;li&gt;热补丁：无需重启即可挂载 eBPF 程序修补已知逻辑缺陷。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="如何使用"&gt;如何使用&lt;/h2&gt;
&lt;h3 id="ebpf工作流程"&gt;eBPF工作流程&lt;/h3&gt;

&lt;div class="mermaid-block" data-mermaid-zoom="1"&gt;
 &lt;div class="mermaid-toolbar"&gt;
 &lt;button class="mermaid-btn" type="button" data-action="zoom-in" aria-label="Zoom in"&gt;+&lt;/button&gt;
 &lt;button class="mermaid-btn" type="button" data-action="zoom-out" aria-label="Zoom out"&gt;-&lt;/button&gt;
 &lt;button class="mermaid-btn" type="button" data-action="reset" aria-label="Reset zoom"&gt;100%&lt;/button&gt;
 &lt;button class="mermaid-btn" type="button" data-action="fullscreen" aria-label="Toggle fullscreen"&gt;Full&lt;/button&gt;
 &lt;/div&gt;
 &lt;div class="mermaid mermaid-canvas"&gt;graph TD
 subgraph User_Space ["用户态 (User Space)"]
 A["编写 eBPF 源代码&lt;br/&gt;(C / Rust)"] -- "LLVM / Clang" --&gt; B["eBPF 字节码&lt;br/&gt;(Bytecode)"]
 B -- "bpf 系统调用" --&gt; C["加载并注入内核"]
 
 L["eBPF Maps&lt;br/&gt;共享存储/键值对"] --- M["用户态控制程序&lt;br/&gt;Go / C++ / Rust"]
 M -- "分析数据" --&gt; N["可视化 / 控制面板"]
 end

 subgraph Kernel_Space ["内核态 (Kernel Space)"]
 C --&gt; D{"验证器 Verifier&lt;br/&gt;安全/权限检查"}
 D -- "拒绝" --&gt; E["报错并停止加载"]
 D -- "通过" --&gt; F["JIT 即时编译器"]
 F --&gt; G["原生机器码&lt;br/&gt;Native Machine Code"]
 
 subgraph Hooks ["事件钩子 (Event Hooks)"]
 H["网络包 XDP/TC"]
 I["系统调用 Syscalls"]
 J["内核函数 Kprobes"]
 K["用户函数 Uprobes"]
 end

 G -- "挂载执行" --&gt; H
 G -- "挂载执行" --&gt; I
 G -- "挂载执行" --&gt; J
 G -- "挂载执行" --&gt; K
 
 H &amp; I &amp; J &amp; K -- "数据交互" --&gt; L
 end

 style D fill:#f96,stroke:#333,stroke-width:2px
 style G fill:#00d2ff,stroke:#333,stroke-width:2px
 style L fill:#fff4dd,stroke:#d4a017,stroke-width:2px&lt;/div&gt;
&lt;/div&gt;
&lt;h3 id="一个加速小例子"&gt;一个加速小例子&lt;/h3&gt;
&lt;p&gt;场景：为局域网内的平板/手机做游戏加速。思路是：数据包进入网关后，如果源 MAC 在“加速名单”且目标 IP 在“游戏服务器列表”，则把流量指派给本地代理端口（示例中用 1080），否则直连。&lt;/p&gt;</description></item><item><title>Ubuntu init process</title><link>https://qtopie.github.io/notes/linux/systemd-service-unit-file/</link><pubDate>Thu, 15 Sep 2016 14:20:15 +0800</pubDate><guid>https://qtopie.github.io/notes/linux/systemd-service-unit-file/</guid><description>&lt;h2 id="history"&gt;History&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;sysVinit&lt;/li&gt;
&lt;li&gt;&lt;a href="http://upstart.ubuntu.com/"&gt;upstart&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;systemd&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ubuntu: sysVinit &amp;ndash;&amp;gt; upstart(6.10+) &amp;ndash;&amp;gt; systemd (15.04+)&lt;/p&gt;
&lt;h3 id="features-of-upstart"&gt;Features of Upstart&lt;/h3&gt;
&lt;p&gt;&lt;em&gt;Event Based&lt;/em&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Start System faster (compare with previous method).&lt;/li&gt;
&lt;li&gt;Dynamically start service when discovering new device&lt;/li&gt;
&lt;li&gt;Dynamically stop service when device is removed&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="systemd"&gt;Systemd&lt;/h2&gt;
&lt;p&gt;Systemd is a collection of system management daemons, utilities and libraries which serves as a replacement of System V init daemon. Systemd functions as
central management and configuration platform for UNIX like system.&lt;/p&gt;</description></item><item><title>Wifi with hostapd</title><link>https://qtopie.github.io/notes/linux/hostapd-wifi/</link><pubDate>Tue, 30 Aug 2016 19:06:18 +0800</pubDate><guid>https://qtopie.github.io/notes/linux/hostapd-wifi/</guid><description>&lt;h2 id="hostapd"&gt;&lt;a href="https://w1.fi/hostapd/"&gt;Hostapd&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;hostapd is a user space daemon for access point and authentication server.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Please follow the guide of &lt;a href="https://www.raspberrypi.org/documentation/configuration/wireless/access-point.md"&gt;Official documentation&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id="installation-and-configuration"&gt;Installation and configuration&lt;/h2&gt;
&lt;p&gt;&lt;em&gt;Tested on raspbian with raspberry pi 3&lt;/em&gt;&lt;/p&gt;
&lt;h3 id="install-hostapd-and-configure-it"&gt;Install hostapd and configure it&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;sudo apt-get install hostapd -y --force-yes&lt;/code&gt;,
also &lt;code&gt;sudo apt-get install haveged&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Edit &lt;code&gt;hostapd.conf&lt;/code&gt;:&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;em&gt;&lt;code&gt;/etc/hostapd/hostapd.conf&lt;/code&gt;&lt;/em&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;interface=wlan0
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;ssid=RPi
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;wpa_passphrase=raspberrypi
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;auth_algs=1
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;wpa=2
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;wpa_key_mgmt=WPA-PSK
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;rsn_pairwise=CCMP
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;channel=10
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;hw_mode=g
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;There should not be any whitespace at the end of each line&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;then modify file &lt;code&gt;/etc/default/hostapd&lt;/code&gt; to let the configuration work
automatically.&lt;/p&gt;</description></item></channel></rss>